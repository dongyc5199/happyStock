# 模拟交易系统详细设计方案

> **文档版本**: v1.0
> **创建日期**: 2025-10-23
> **目标阶段**: MVP Phase - Week 7-8
> **预计开发周期**: 2周

---

## 📋 目录

1. [系统概述](#1-系统概述)
2. [架构设计](#2-架构设计)
3. [数据库设计](#3-数据库设计)
4. [后端API设计](#4-后端api设计)
5. [前端界面设计](#5-前端界面设计)
6. [交易引擎核心逻辑](#6-交易引擎核心逻辑)
7. [技术选型](#7-技术选型)
8. [开发计划](#8-开发计划)
9. [测试方案](#9-测试方案)
10. [风险控制](#10-风险控制)

---

## 1. 系统概述

### 1.1 功能定位

模拟交易系统是 happyStock 平台的核心功能模块，提供零风险的股票交易模拟环境，帮助用户学习投资技能。

### 1.2 核心功能

- ✅ **账户管理**: 创建、查询、重置模拟账户
- ✅ **交易执行**: 买入/卖出股票（基于实时或延时行情）
- ✅ **持仓管理**: 查询持仓、计算盈亏、持仓分析
- ✅ **交易记录**: 完整的交易历史记录和查询
- ✅ **资产数据**: 股票列表、实时价格、基础信息
- ✅ **风险控制**: 资金充足性验证、持仓数量验证

### 1.3 MVP 范围界定

**包含功能**:
- 模拟账户的 CRUD 操作
- 基础买入/卖出交易
- 持仓查询和盈亏计算
- 交易历史记录
- 简单的前端交易界面

**不包含功能** (后续迭代):
- 限价单、止损单等高级订单类型
- 融资融券
- AI 智能推荐
- 回测功能
- 复杂的图表分析

### 1.4 成功指标

- **功能完整性**: 核心交易流程端到端可用
- **性能指标**:
  - 交易响应时间 < 500ms
  - 持仓查询 < 200ms
  - 支持单账户 100+ 持仓
- **准确性**: 资金和持仓计算 100% 准确，无精度损失
- **可用性**: 系统可用性 > 99%

---

## 2. 架构设计

### 2.1 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                         Frontend (Next.js)                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  交易页面    │  │  持仓页面    │  │  历史记录    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│           │                 │                 │              │
│           └─────────────────┴─────────────────┘              │
│                         │ REST API                           │
└─────────────────────────┼─────────────────────────────────────┘
                          │
┌─────────────────────────┼─────────────────────────────────────┐
│                    Backend (FastAPI)                          │
│  ┌──────────────────────────────────────────────────────┐    │
│  │                   API Layer (路由)                    │    │
│  │  /accounts  /trades  /holdings  /assets              │    │
│  └──────────────────────┬───────────────────────────────┘    │
│                         │                                     │
│  ┌──────────────────────┴───────────────────────────────┐    │
│  │              Business Logic Layer (服务层)            │    │
│  │  AccountService  TradeService  HoldingService        │    │
│  └──────────────────────┬───────────────────────────────┘    │
│                         │                                     │
│  ┌──────────────────────┴───────────────────────────────┐    │
│  │                 Trading Engine (交易引擎)             │    │
│  │  - 订单验证  - 交易撮合  - 持仓更新  - 余额计算      │    │
│  └──────────────────────┬───────────────────────────────┘    │
│                         │                                     │
│  ┌──────────────────────┴───────────────────────────────┐    │
│  │              Data Access Layer (数据访问层)           │    │
│  │  ORM Models (Tortoise-ORM / SQLAlchemy)              │    │
│  └──────────────────────┬───────────────────────────────┘    │
└─────────────────────────┼─────────────────────────────────────┘
                          │
┌─────────────────────────┼─────────────────────────────────────┐
│              Database (PostgreSQL + Redis)                    │
│  ┌─────────────────┐  ┌─────────────────┐                    │
│  │   PostgreSQL    │  │      Redis       │                    │
│  │  - users        │  │  - 价格缓存      │                    │
│  │  - sim_accounts │  │  - 会话数据      │                    │
│  │  - sim_trades   │  │  - 实时行情      │                    │
│  │  - sim_holdings │  │                  │                    │
│  │  - assets       │  │                  │                    │
│  └─────────────────┘  └─────────────────┘                    │
└───────────────────────────────────────────────────────────────┘
                          │
┌─────────────────────────┼─────────────────────────────────────┐
│              External Services (外部服务)                      │
│  ┌─────────────────┐  ┌─────────────────┐                    │
│  │  行情数据 API   │  │   AI 服务(未来)  │                    │
│  │  - 新浪财经     │  │  - Claude API    │                    │
│  │  - 东方财富     │  │  - 交易建议      │                    │
│  └─────────────────┘  └─────────────────┘                    │
└───────────────────────────────────────────────────────────────┘
```

### 2.2 技术架构分层

| 层级 | 职责 | 技术栈 |
|------|------|--------|
| **表现层** | 用户界面、交互逻辑 | Next.js 15, React 19, Tailwind CSS |
| **API层** | 路由、请求处理、参数验证 | FastAPI, Pydantic |
| **业务逻辑层** | 业务规则、流程控制 | Python Services |
| **交易引擎层** | 核心交易逻辑、计算 | Python Classes |
| **数据访问层** | ORM、数据库操作 | Tortoise-ORM / SQLAlchemy |
| **数据存储层** | 持久化存储 | PostgreSQL, Redis |
| **外部服务层** | 第三方 API 集成 | HTTP Client, WebSocket |

### 2.3 数据流设计

#### 买入交易流程
```
用户 → 前端表单 → API请求 → 参数验证
  → 交易引擎:
     1. 查询账户余额
     2. 获取实时价格
     3. 计算交易金额
     4. 验证资金充足性
     5. 扣减账户余额
     6. 创建交易记录
     7. 更新/创建持仓记录
     8. 返回交易结果
  → 前端更新UI → 用户反馈
```

#### 卖出交易流程
```
用户 → 前端表单 → API请求 → 参数验证
  → 交易引擎:
     1. 查询持仓数量
     2. 获取实时价格
     3. 验证持仓充足性
     4. 计算卖出金额
     5. 增加账户余额
     6. 创建交易记录
     7. 减少持仓数量
     8. 返回交易结果
  → 前端更新UI → 用户反馈
```

---

## 3. 数据库设计

### 3.1 ER 关系图

```
┌─────────────┐
│   users     │
│  (用户表)   │
└──────┬──────┘
       │ 1
       │
       │ N
┌──────┴────────────┐
│   sim_accounts    │
│  (模拟账户表)     │
└──────┬────────────┘
       │ 1
       ├─────────────┐
       │             │
       │ N           │ N
┌──────┴────────┐   │
│  sim_trades   │   │
│ (交易记录表)  │   │
└───────────────┘   │
                    │
              ┌─────┴─────────┐
              │ sim_holdings  │
              │ (持仓表)      │
              └─────┬─────────┘
                    │ N
                    │
                    │ 1
              ┌─────┴─────┐
              │  assets   │
              │ (资产表)  │
              └───────────┘
```

### 3.2 核心表结构 (已实现)

详见 `sql_scripts/create_user_table.sql`

**关键约束和索引建议**:

```sql
-- 为常用查询添加索引
CREATE INDEX idx_sim_accounts_user_id ON sim_accounts(user_id);
CREATE INDEX idx_sim_trades_account_id ON sim_trades(account_id);
CREATE INDEX idx_sim_trades_asset_id ON sim_trades(asset_id);
CREATE INDEX idx_sim_trades_trade_time ON sim_trades(trade_time DESC);
CREATE INDEX idx_sim_holdings_account_id ON sim_holdings(account_id);
CREATE INDEX idx_assets_symbol ON assets(symbol);
CREATE INDEX idx_assets_asset_type ON assets(asset_type);
```

### 3.3 数据完整性规则

1. **账户余额一致性**: `current_balance >= 0`
2. **持仓数量一致性**: `quantity > 0` (卖完自动删除记录)
3. **交易金额精度**: 使用 DECIMAL(18,2) 避免浮点数误差
4. **级联删除**: 用户删除 → 账户删除 → 交易记录删除 + 持仓删除

---

## 4. 后端API设计

### 4.1 API 基础规范

- **Base URL**: `http://localhost:8000/api/v1`
- **认证方式**: JWT Bearer Token (需要先实现用户认证系统)
- **响应格式**: JSON
- **HTTP 状态码**:
  - 200: 成功
  - 201: 创建成功
  - 400: 请求参数错误
  - 401: 未授权
  - 404: 资源不存在
  - 500: 服务器错误

### 4.2 统一响应结构

```json
// 成功响应
{
  "success": true,
  "data": { ... },
  "message": "操作成功"
}

// 错误响应
{
  "success": false,
  "error": {
    "code": "INSUFFICIENT_BALANCE",
    "message": "账户余额不足",
    "details": { ... }
  }
}
```

### 4.3 API 接口详细设计

#### 4.3.1 账户管理 API

##### POST /api/v1/accounts
**功能**: 创建模拟账户

**请求体**:
```json
{
  "user_id": 1,
  "account_name": "我的第一个账户",
  "initial_balance": 100000.00
}
```

**响应**:
```json
{
  "success": true,
  "data": {
    "id": 1,
    "user_id": 1,
    "account_name": "我的第一个账户",
    "initial_balance": 100000.00,
    "current_balance": 100000.00,
    "created_at": "2025-10-23T10:00:00Z"
  }
}
```

**业务规则**:
- 默认初始资金: ¥100,000
- 单个用户最多创建 3 个账户
- 账户名称不能为空，最长 100 字符

---

##### GET /api/v1/accounts/{account_id}
**功能**: 获取账户详情

**路径参数**:
- `account_id`: 账户 ID

**响应**:
```json
{
  "success": true,
  "data": {
    "id": 1,
    "user_id": 1,
    "account_name": "我的第一个账户",
    "initial_balance": 100000.00,
    "current_balance": 85000.00,
    "total_assets": 125000.00,
    "total_profit": 10000.00,
    "profit_rate": 10.0,
    "created_at": "2025-10-23T10:00:00Z"
  }
}
```

**计算逻辑**:
- `total_assets` = `current_balance` + 所有持仓市值
- `total_profit` = `total_assets` - `initial_balance`
- `profit_rate` = (`total_profit` / `initial_balance`) * 100

---

##### GET /api/v1/accounts/user/{user_id}
**功能**: 获取用户的所有账户

**查询参数**:
- `page`: 页码 (默认: 1)
- `page_size`: 每页数量 (默认: 10)

**响应**:
```json
{
  "success": true,
  "data": {
    "accounts": [ ... ],
    "total": 2,
    "page": 1,
    "page_size": 10
  }
}
```

---

##### PUT /api/v1/accounts/{account_id}/reset
**功能**: 重置账户 (清空持仓和交易记录，恢复初始资金)

**响应**:
```json
{
  "success": true,
  "message": "账户已重置",
  "data": {
    "id": 1,
    "current_balance": 100000.00
  }
}
```

**业务规则**:
- 删除该账户所有持仓记录
- 删除该账户所有交易记录
- 重置余额为初始资金

---

#### 4.3.2 交易执行 API

##### POST /api/v1/trades/buy
**功能**: 买入交易

**请求体**:
```json
{
  "account_id": 1,
  "asset_symbol": "600000",
  "quantity": 100,
  "price": 12.50
}
```

**响应**:
```json
{
  "success": true,
  "data": {
    "trade_id": 1001,
    "account_id": 1,
    "asset_id": 5,
    "asset_symbol": "600000",
    "asset_name": "浦发银行",
    "trade_type": "BUY",
    "quantity": 100,
    "price": 12.50,
    "total_amount": 1250.00,
    "trade_time": "2025-10-23T14:30:00Z",
    "account_balance_after": 98750.00
  }
}
```

**业务规则**:
1. 验证账户存在
2. 验证资产存在
3. 计算交易金额: `total_amount = quantity * price`
4. 验证余额充足: `current_balance >= total_amount`
5. 扣减余额
6. 创建交易记录
7. 更新或创建持仓记录

**错误示例**:
```json
{
  "success": false,
  "error": {
    "code": "INSUFFICIENT_BALANCE",
    "message": "账户余额不足，当前余额: ¥1000.00, 需要: ¥1250.00"
  }
}
```

---

##### POST /api/v1/trades/sell
**功能**: 卖出交易

**请求体**:
```json
{
  "account_id": 1,
  "asset_symbol": "600000",
  "quantity": 50,
  "price": 13.00
}
```

**响应**:
```json
{
  "success": true,
  "data": {
    "trade_id": 1002,
    "account_id": 1,
    "asset_id": 5,
    "asset_symbol": "600000",
    "asset_name": "浦发银行",
    "trade_type": "SELL",
    "quantity": 50,
    "price": 13.00,
    "total_amount": 650.00,
    "profit": 25.00,
    "profit_rate": 4.0,
    "trade_time": "2025-10-23T15:00:00Z",
    "account_balance_after": 99400.00
  }
}
```

**业务规则**:
1. 验证持仓存在
2. 验证持仓数量充足: `holding_quantity >= sell_quantity`
3. 计算卖出金额: `total_amount = quantity * price`
4. 计算盈亏: `profit = (price - avg_price) * quantity`
5. 增加余额
6. 创建交易记录
7. 减少持仓数量 (如果卖完则删除持仓记录)

**错误示例**:
```json
{
  "success": false,
  "error": {
    "code": "INSUFFICIENT_HOLDINGS",
    "message": "持仓数量不足，当前持仓: 30, 尝试卖出: 50"
  }
}
```

---

##### GET /api/v1/trades/{account_id}
**功能**: 获取交易历史

**查询参数**:
- `trade_type`: 交易类型 (BUY/SELL，可选)
- `asset_symbol`: 资产代码 (可选)
- `start_date`: 开始日期 (可选)
- `end_date`: 结束日期 (可选)
- `page`: 页码 (默认: 1)
- `page_size`: 每页数量 (默认: 20)

**响应**:
```json
{
  "success": true,
  "data": {
    "trades": [
      {
        "id": 1002,
        "trade_type": "SELL",
        "asset_symbol": "600000",
        "asset_name": "浦发银行",
        "quantity": 50,
        "price": 13.00,
        "total_amount": 650.00,
        "trade_time": "2025-10-23T15:00:00Z"
      },
      {
        "id": 1001,
        "trade_type": "BUY",
        "asset_symbol": "600000",
        "asset_name": "浦发银行",
        "quantity": 100,
        "price": 12.50,
        "total_amount": 1250.00,
        "trade_time": "2025-10-23T14:30:00Z"
      }
    ],
    "total": 2,
    "page": 1,
    "page_size": 20
  }
}
```

---

#### 4.3.3 持仓管理 API

##### GET /api/v1/holdings/{account_id}
**功能**: 获取账户持仓列表

**响应**:
```json
{
  "success": true,
  "data": {
    "holdings": [
      {
        "id": 1,
        "asset_id": 5,
        "asset_symbol": "600000",
        "asset_name": "浦发银行",
        "quantity": 50,
        "avg_price": 12.50,
        "current_price": 13.00,
        "cost": 625.00,
        "market_value": 650.00,
        "profit": 25.00,
        "profit_rate": 4.0
      }
    ],
    "summary": {
      "total_cost": 625.00,
      "total_market_value": 650.00,
      "total_profit": 25.00,
      "total_profit_rate": 4.0
    }
  }
}
```

**计算逻辑**:
- `cost` = `quantity * avg_price`
- `market_value` = `quantity * current_price`
- `profit` = `market_value - cost`
- `profit_rate` = (`profit / cost`) * 100

---

##### GET /api/v1/holdings/{account_id}/summary
**功能**: 获取持仓汇总

**响应**:
```json
{
  "success": true,
  "data": {
    "account_balance": 98750.00,
    "total_market_value": 650.00,
    "total_assets": 99400.00,
    "total_cost": 625.00,
    "total_profit": 25.00,
    "total_profit_rate": 4.0,
    "holdings_count": 1,
    "asset_allocation": [
      {
        "asset_type": "股票",
        "market_value": 650.00,
        "percentage": 100.0
      }
    ]
  }
}
```

---

#### 4.3.4 资产数据 API

##### GET /api/v1/assets
**功能**: 获取可交易资产列表

**查询参数**:
- `asset_type`: 资产类型 (股票/基金/虚拟货币，可选)
- `exchange`: 交易所 (可选)
- `keyword`: 搜索关键词 (代码或名称，可选)
- `page`: 页码 (默认: 1)
- `page_size`: 每页数量 (默认: 50)

**响应**:
```json
{
  "success": true,
  "data": {
    "assets": [
      {
        "id": 5,
        "symbol": "600000",
        "name": "浦发银行",
        "exchange": "上海证券交易所",
        "asset_type": "股票",
        "current_price": 13.00,
        "created_at": "2025-10-20T00:00:00Z"
      }
    ],
    "total": 100,
    "page": 1,
    "page_size": 50
  }
}
```

---

##### GET /api/v1/assets/{symbol}
**功能**: 获取资产详情

**响应**:
```json
{
  "success": true,
  "data": {
    "id": 5,
    "symbol": "600000",
    "name": "浦发银行",
    "exchange": "上海证券交易所",
    "asset_type": "股票",
    "current_price": 13.00,
    "open_price": 12.80,
    "high_price": 13.20,
    "low_price": 12.75,
    "volume": 1500000,
    "change": 0.20,
    "change_percent": 1.56,
    "updated_at": "2025-10-23T15:00:00Z"
  }
}
```

---

##### GET /api/v1/assets/{symbol}/price
**功能**: 获取实时价格 (用于交易前确认)

**响应**:
```json
{
  "success": true,
  "data": {
    "symbol": "600000",
    "price": 13.00,
    "timestamp": "2025-10-23T15:00:00Z"
  }
}
```

---

### 4.4 错误码定义

| 错误码 | 说明 | HTTP状态码 |
|--------|------|-----------|
| ACCOUNT_NOT_FOUND | 账户不存在 | 404 |
| ASSET_NOT_FOUND | 资产不存在 | 404 |
| INSUFFICIENT_BALANCE | 余额不足 | 400 |
| INSUFFICIENT_HOLDINGS | 持仓不足 | 400 |
| INVALID_QUANTITY | 交易数量无效 | 400 |
| INVALID_PRICE | 价格无效 | 400 |
| ACCOUNT_LIMIT_REACHED | 账户数量达到上限 | 400 |
| TRADE_FAILED | 交易执行失败 | 500 |
| DATABASE_ERROR | 数据库错误 | 500 |

---

## 5. 前端界面设计

### 5.1 页面结构

```
/trading (模拟交易主页)
  ├── /trading/accounts (账户管理)
  ├── /trading/trade (交易界面)
  ├── /trading/holdings (持仓管理)
  └── /trading/history (交易历史)
```

### 5.2 核心页面设计

#### 5.2.1 交易主页 (`/trading`)

**布局**:
```
┌─────────────────────────────────────────────────────────────┐
│                         顶部导航栏                          │
├─────────────────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────────────────────┐ │
│  │  账户总览卡片                                          │ │
│  │  - 账户名称: 我的第一个账户                            │ │
│  │  - 总资产: ¥125,000.00  (+10.0%)                      │ │
│  │  - 可用余额: ¥85,000.00                                │ │
│  │  - 持仓市值: ¥40,000.00                                │ │
│  │  - 今日盈亏: +¥500.00 (+0.4%)                         │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                               │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  快速交易面板                                          │ │
│  │  ┌──────────────┐  ┌──────────────┐                   │ │
│  │  │   买入 BUY   │  │  卖出 SELL   │  (Tab切换)        │ │
│  │  └──────────────┘  └──────────────┘                   │ │
│  │                                                         │ │
│  │  股票代码: [______] (带搜索建议)                       │ │
│  │  当前价格: ¥13.00                                       │ │
│  │  交易数量: [______] 手                                  │ │
│  │  交易金额: ¥1,300.00                                    │ │
│  │                                                         │ │
│  │  [确认买入]  [取消]                                     │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                               │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  当前持仓 (前5条)                          [查看更多]   │ │
│  │  ┌──────────────────────────────────────────────────┐ │ │
│  │  │ 代码   │ 名称   │ 数量 │ 成本 │ 现价 │ 盈亏      │ │ │
│  │  ├──────────────────────────────────────────────────┤ │ │
│  │  │ 600000│浦发银行│ 100 │12.50│13.00│+¥50 (+4%) │ │ │
│  │  └──────────────────────────────────────────────────┘ │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                               │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  最近交易 (前5条)                          [查看更多]   │ │
│  │  ┌──────────────────────────────────────────────────┐ │ │
│  │  │时间    │类型│代码  │名称  │数量│价格│金额      │ │ │
│  │  ├──────────────────────────────────────────────────┤ │ │
│  │  │15:00  │卖出│600000│浦发  │ 50│13.00│¥650     │ │ │
│  │  │14:30  │买入│600000│浦发  │100│12.50│¥1,250   │ │ │
│  │  └──────────────────────────────────────────────────┘ │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

**组件清单**:
- `AccountSummaryCard`: 账户总览卡片
- `QuickTradePanel`: 快速交易面板
  - `AssetSearchInput`: 资产搜索输入框（带自动完成）
  - `PriceDisplay`: 价格显示组件
  - `QuantityInput`: 数量输入框
  - `TradeButton`: 交易按钮
- `HoldingsList`: 持仓列表（简化版）
- `RecentTradesList`: 最近交易列表（简化版）

---

#### 5.2.2 交易界面 (`/trading/trade`)

**布局**: 左右分屏
```
┌─────────────────────────────────────────────────────────────┐
│  ┌──────────────────────────┐  ┌────────────────────────┐  │
│  │  左侧：资产选择 & 信息   │  │  右侧：交易表单        │  │
│  │                          │  │                        │  │
│  │  搜索: [_____________]   │  │  [买入] [卖出] (Tab)   │  │
│  │                          │  │                        │  │
│  │  热门股票:               │  │  股票: 600000 浦发银行 │  │
│  │  - 600000 浦发银行       │  │  现价: ¥13.00          │  │
│  │  - 600036 招商银行       │  │  涨跌: +¥0.20 (+1.56%) │  │
│  │  - 000001 平安银行       │  │                        │  │
│  │                          │  │  数量: [______] 手     │  │
│  │  我的持仓:               │  │  可用: 100 手          │  │
│  │  - 600000 浦发银行       │  │                        │  │
│  │    持仓100手             │  │  预估金额: ¥1,300.00   │  │
│  │                          │  │  手续费: ¥0.00         │  │
│  │                          │  │  实际金额: ¥1,300.00   │  │
│  │                          │  │                        │  │
│  │                          │  │  [确认交易]            │  │
│  └──────────────────────────┘  └────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

**交互逻辑**:
1. 左侧点击资产 → 自动填充右侧表单
2. 输入数量 → 实时计算预估金额
3. 点击"确认交易" → 显示确认弹窗 → 调用 API → 显示结果
4. 交易成功 → Toast 提示 → 刷新账户余额和持仓

---

#### 5.2.3 持仓管理 (`/trading/holdings`)

**表格列**:
- 股票代码
- 股票名称
- 持仓数量
- 成本价
- 当前价
- 市值
- 盈亏金额
- 盈亏比例
- 操作（快速卖出）

**功能**:
- 排序: 按盈亏、市值、数量排序
- 筛选: 按资产类型筛选
- 详情: 点击行展开详细信息（买入历史、持仓分布）
- 操作: 快速卖出按钮 → 跳转到交易页面并预填

---

#### 5.2.4 交易历史 (`/trading/history`)

**筛选条件**:
- 日期范围选择器
- 交易类型: 全部/买入/卖出
- 股票代码搜索

**表格列**:
- 交易时间
- 交易类型（带颜色标识）
- 股票代码
- 股票名称
- 数量
- 价格
- 金额
- 状态（成功/失败）

**导出功能**: 导出 CSV (可选)

---

#### 5.2.5 账户管理 (`/trading/accounts`)

**功能**:
- 账户列表展示
- 创建新账户（弹窗）
- 切换当前账户
- 重置账户（确认弹窗）
- 删除账户（确认弹窗）

---

### 5.3 前端技术实现

#### 5.3.1 状态管理

使用 **Zustand** 进行全局状态管理:

```typescript
// stores/tradingStore.ts
import create from 'zustand';

interface TradingState {
  currentAccount: Account | null;
  holdings: Holding[];
  recentTrades: Trade[];

  // Actions
  setCurrentAccount: (account: Account) => void;
  fetchHoldings: (accountId: number) => Promise<void>;
  executeTrade: (tradeData: TradeRequest) => Promise<void>;
}

export const useTradingStore = create<TradingState>((set, get) => ({
  currentAccount: null,
  holdings: [],
  recentTrades: [],

  setCurrentAccount: (account) => set({ currentAccount: account }),

  fetchHoldings: async (accountId) => {
    const response = await fetch(`/api/v1/holdings/${accountId}`);
    const data = await response.json();
    set({ holdings: data.data.holdings });
  },

  executeTrade: async (tradeData) => {
    // 调用交易 API
    // 更新状态
  }
}));
```

#### 5.3.2 API 调用封装

```typescript
// lib/api/trading.ts
import { apiClient } from './client';

export const tradingApi = {
  // 账户相关
  getAccount: (accountId: number) =>
    apiClient.get(`/accounts/${accountId}`),

  createAccount: (data: CreateAccountRequest) =>
    apiClient.post('/accounts', data),

  // 交易相关
  buyAsset: (data: BuyRequest) =>
    apiClient.post('/trades/buy', data),

  sellAsset: (data: SellRequest) =>
    apiClient.post('/trades/sell', data),

  getTradeHistory: (accountId: number, params?: TradeQueryParams) =>
    apiClient.get(`/trades/${accountId}`, { params }),

  // 持仓相关
  getHoldings: (accountId: number) =>
    apiClient.get(`/holdings/${accountId}`),

  // 资产相关
  searchAssets: (keyword: string) =>
    apiClient.get('/assets', { params: { keyword } }),

  getAssetPrice: (symbol: string) =>
    apiClient.get(`/assets/${symbol}/price`)
};
```

#### 5.3.3 表单验证

使用 **Zod** 进行表单验证:

```typescript
import { z } from 'zod';

export const buyTradeSchema = z.object({
  account_id: z.number().positive(),
  asset_symbol: z.string().min(6).max(6),
  quantity: z.number().positive().min(1),
  price: z.number().positive()
});

export type BuyTradeInput = z.infer<typeof buyTradeSchema>;
```

---

## 6. 交易引擎核心逻辑

### 6.1 交易引擎类设计

```python
# backend/services/trading_engine.py

from decimal import Decimal
from typing import Dict, Optional
from models import SimAccount, SimTrade, SimHolding, Asset

class TradingEngine:
    """交易引擎核心类"""

    async def execute_buy(
        self,
        account_id: int,
        asset_symbol: str,
        quantity: Decimal,
        price: Decimal
    ) -> Dict:
        """
        执行买入交易

        Args:
            account_id: 账户ID
            asset_symbol: 资产代码
            quantity: 买入数量
            price: 买入价格

        Returns:
            交易结果字典

        Raises:
            InsufficientBalanceError: 余额不足
            AssetNotFoundError: 资产不存在
        """
        # 1. 查询账户
        account = await SimAccount.get(id=account_id)

        # 2. 查询资产
        asset = await Asset.get(symbol=asset_symbol)

        # 3. 计算交易金额
        total_amount = quantity * price

        # 4. 验证余额
        if account.current_balance < total_amount:
            raise InsufficientBalanceError(
                f"余额不足: 当前 {account.current_balance}, 需要 {total_amount}"
            )

        # 5. 开启事务
        async with in_transaction():
            # 6. 扣减余额
            account.current_balance -= total_amount
            await account.save()

            # 7. 创建交易记录
            trade = await SimTrade.create(
                account_id=account_id,
                asset_id=asset.id,
                trade_type="BUY",
                quantity=quantity,
                price=price
            )

            # 8. 更新持仓
            holding = await SimHolding.get_or_none(
                account_id=account_id,
                asset_id=asset.id
            )

            if holding:
                # 已有持仓：更新数量和成本价
                new_quantity = holding.quantity + quantity
                new_avg_price = (
                    (holding.quantity * holding.avg_price + quantity * price)
                    / new_quantity
                )
                holding.quantity = new_quantity
                holding.avg_price = new_avg_price
                await holding.save()
            else:
                # 新建持仓
                holding = await SimHolding.create(
                    account_id=account_id,
                    asset_id=asset.id,
                    quantity=quantity,
                    avg_price=price
                )

        # 9. 返回结果
        return {
            "trade_id": trade.id,
            "account_id": account_id,
            "asset_symbol": asset_symbol,
            "asset_name": asset.name,
            "trade_type": "BUY",
            "quantity": quantity,
            "price": price,
            "total_amount": total_amount,
            "account_balance_after": account.current_balance
        }

    async def execute_sell(
        self,
        account_id: int,
        asset_symbol: str,
        quantity: Decimal,
        price: Decimal
    ) -> Dict:
        """
        执行卖出交易

        Args:
            account_id: 账户ID
            asset_symbol: 资产代码
            quantity: 卖出数量
            price: 卖出价格

        Returns:
            交易结果字典

        Raises:
            InsufficientHoldingsError: 持仓不足
            HoldingNotFoundError: 持仓不存在
        """
        # 1. 查询资产
        asset = await Asset.get(symbol=asset_symbol)

        # 2. 查询持仓
        holding = await SimHolding.get_or_none(
            account_id=account_id,
            asset_id=asset.id
        )

        if not holding:
            raise HoldingNotFoundError(f"未持有资产 {asset_symbol}")

        # 3. 验证持仓数量
        if holding.quantity < quantity:
            raise InsufficientHoldingsError(
                f"持仓不足: 当前 {holding.quantity}, 尝试卖出 {quantity}"
            )

        # 4. 计算交易金额和盈亏
        total_amount = quantity * price
        profit = (price - holding.avg_price) * quantity
        profit_rate = (profit / (holding.avg_price * quantity)) * 100

        # 5. 开启事务
        async with in_transaction():
            # 6. 查询账户并增加余额
            account = await SimAccount.get(id=account_id)
            account.current_balance += total_amount
            await account.save()

            # 7. 创建交易记录
            trade = await SimTrade.create(
                account_id=account_id,
                asset_id=asset.id,
                trade_type="SELL",
                quantity=quantity,
                price=price
            )

            # 8. 更新持仓
            if holding.quantity == quantity:
                # 全部卖出：删除持仓记录
                await holding.delete()
            else:
                # 部分卖出：减少数量
                holding.quantity -= quantity
                await holding.save()

        # 9. 返回结果
        return {
            "trade_id": trade.id,
            "account_id": account_id,
            "asset_symbol": asset_symbol,
            "asset_name": asset.name,
            "trade_type": "SELL",
            "quantity": quantity,
            "price": price,
            "total_amount": total_amount,
            "profit": profit,
            "profit_rate": profit_rate,
            "account_balance_after": account.current_balance
        }

    async def calculate_holding_profit(
        self,
        holding: SimHolding,
        current_price: Decimal
    ) -> Dict:
        """计算持仓盈亏"""
        cost = holding.quantity * holding.avg_price
        market_value = holding.quantity * current_price
        profit = market_value - cost
        profit_rate = (profit / cost) * 100 if cost > 0 else 0

        return {
            "cost": cost,
            "market_value": market_value,
            "profit": profit,
            "profit_rate": profit_rate
        }
```

### 6.2 事务处理

使用数据库事务确保数据一致性:

```python
from tortoise.transactions import in_transaction

async def execute_trade_with_transaction():
    async with in_transaction() as connection:
        # 所有数据库操作
        # 如果任何操作失败，自动回滚
        pass
```

### 6.3 并发控制

使用行级锁防止并发问题:

```python
# 使用 SELECT FOR UPDATE 锁定账户记录
account = await SimAccount.select_for_update().get(id=account_id)
```

---

## 7. 技术选型

### 7.1 后端技术栈

| 组件 | 技术选型 | 理由 |
|------|---------|------|
| Web 框架 | FastAPI | 高性能、异步支持、自动文档 |
| ORM | Tortoise-ORM | FastAPI 原生异步支持、类 Django ORM |
| 数据验证 | Pydantic | FastAPI 内置、类型安全 |
| 数据库 | PostgreSQL 14+ | 成熟稳定、支持事务、ACID |
| 缓存 | Redis 7+ | 高性能、支持多种数据结构 |
| 任务队列 | Celery (可选) | 异步任务处理（如行情更新） |

### 7.2 前端技术栈

| 组件 | 技术选型 | 理由 |
|------|---------|------|
| 框架 | Next.js 15 | 已选定、SSR 支持、性能优秀 |
| UI 库 | Ant Design / shadcn/ui | 组件丰富、企业级 |
| 状态管理 | Zustand | 轻量、简单、TypeScript 友好 |
| 表单 | React Hook Form + Zod | 性能好、验证强大 |
| 图表 | Recharts / ECharts | 数据可视化（持仓饼图、收益曲线） |
| 请求库 | Axios / Fetch | 已有封装 |

### 7.3 开发工具

- **API 文档**: FastAPI 自动生成 Swagger/OpenAPI
- **API 测试**: Bruno / Postman
- **数据库管理**: DBeaver / pgAdmin
- **Mock 数据**: Faker (Python) / Mock Service Worker (前端)

---

## 8. 开发计划

### 8.1 Week 7 (第一周)

#### Day 1-2: 后端基础设施 ✅
- [x] 配置数据库连接 (Tortoise-ORM)
- [x] 创建 ORM Models
- [x] 执行建表脚本
- [x] 编写数据库 seed 脚本（测试数据）
- [x] 配置 FastAPI 项目结构
  ```
  backend/
  ├── main.py                    # FastAPI 应用入口 ✅
  ├── config.py                  # 数据库配置 ✅
  ├── exceptions.py              # 自定义异常类 ✅
  ├── utils.py                   # 工具函数 ✅
  ├── models/                    # ORM 模型 ✅
  │   ├── __init__.py
  │   ├── user.py
  │   ├── account.py
  │   ├── trade.py
  │   ├── holding.py
  │   └── asset.py
  ├── services/                  # 业务逻辑服务 ✅
  │   ├── __init__.py
  │   ├── account_service.py
  │   ├── trade_service.py       # 包含交易引擎逻辑
  │   └── asset_service.py
  ├── routers/                   # API 路由 ✅
  │   ├── __init__.py
  │   ├── accounts.py
  │   ├── trades.py
  │   ├── holdings.py
  │   ├── assets.py
  │   └── klines.py              # K线数据API
  ├── schemas/                   # Pydantic 数据模型 ✅
  │   ├── __init__.py
  │   ├── requests.py
  │   ├── responses.py
  │   └── kline.py
  ├── scripts/                   # 工具脚本 ✅
  │   ├── __init__.py
  │   └── init_test_data.py
  └── tests/                     # 测试目录
      └── __init__.py
  ```

#### Day 3-4: 账户和资产 API ✅
- [x] 实现账户管理 API (创建、查询、重置、更新、删除)
  - POST `/api/v1/accounts` - 创建账户
  - GET `/api/v1/accounts/{account_id}` - 获取账户详情
  - GET `/api/v1/accounts/user/{user_id}` - 获取用户账户列表
  - PUT `/api/v1/accounts/{account_id}/reset` - 重置账户
  - PATCH `/api/v1/accounts/{account_id}` - 更新账户信息
  - DELETE `/api/v1/accounts/{account_id}` - 删除账户
- [x] 实现资产管理 API (列表、搜索、详情)
  - GET `/api/v1/assets` - 资产列表（支持搜索和筛选）
  - GET `/api/v1/assets/{symbol}` - 获取资产详情
- [x] 实现 K线数据 API
  - GET `/api/v1/klines/{symbol}` - 获取K线数据
- [x] 编写测试数据初始化脚本 (`backend/scripts/init_test_data.py`)
- [x] 使用 FastAPI 自动文档测试 API (Swagger UI)

#### Day 5-7: 交易引擎和交易 API ✅
- [x] 实现交易引擎核心逻辑（在 TradeService 中）
  - 使用数据库事务保证原子性 (`in_transaction`)
  - 实现并发控制（事务隔离）
  - 精确的余额和持仓计算（使用 Decimal 类型）
  - 完整的错误处理和异常机制
- [x] 实现买入交易 API
  - POST `/api/v1/trades/buy` - 执行买入
  - 验证余额充足性
  - 自动更新或创建持仓（计算平均成本价）
- [x] 实现卖出交易 API
  - POST `/api/v1/trades/sell` - 执行卖出
  - 验证持仓充足性
  - 自动减少或删除持仓
- [x] 实现交易历史 API
  - GET `/api/v1/trades/history` - 查询交易记录
  - 支持按资产、类型筛选
  - 支持分页查询
- [x] 实现异常处理机制
  - 自定义业务异常类（`exceptions.py`）
  - 统一的错误响应格式
- [ ] 编写单元测试和集成测试（待完善）
- [ ] 性能测试（待完善）

### 8.2 Week 8 (第二周)

#### Day 1-2: 持仓管理 API ✅
- [x] 实现持仓查询 API
  - GET `/api/v1/holdings/{account_id}` - 获取持仓列表
  - 包含成本、市值、盈亏计算
- [x] 实现持仓汇总 API
  - GET `/api/v1/holdings/{account_id}/summary` - 持仓汇总
  - 包含总资产、总盈亏、资产配置
- [x] 实现盈亏计算逻辑
  - 持仓模型中的 `calculate_profit()` 方法
  - 账户模型中的 `calculate_total_assets()` 和 `calculate_profit()` 方法
- [x] 使用模拟价格（Asset 表的 current_price 字段）

#### Day 3-5: 前端界面开发 ⏳ (部分完成)
- [x] 创建交易相关组件
  - `TradePanel.tsx` - 买入/卖出交易面板
  - `TradeConfirmDialog.tsx` - 交易确认对话框
  - `TradeHistory.tsx` - 交易历史组件
- [x] 实现状态管理（Zustand）
  - 创建 `tradingStore` 管理交易状态
- [x] 实现交易表单逻辑
  - 表单验证
  - 实时金额计算
  - 余额和持仓检查
- [ ] 实现完整页面路由（待完善）
- [ ] 实现账户总览页面（待完善）
- [ ] 实现持仓列表页面（待完善）
- [ ] 实现交易历史页面（待完善）
- [ ] 实现账户管理页面（待完善）

#### Day 6-7: 联调和优化 ⏳ (进行中)
- [x] 基础前后端联调
- [x] 错误处理机制
  - 后端统一异常处理
  - 前端错误消息显示
- [x] 表单验证和用户反馈
- [ ] 完整的前后端集成测试（待完善）
- [ ] UI/UX 深度优化（待完善）
- [ ] 加载状态和骨架屏（待完善）
- [ ] 性能优化（待完善）

---

## 9. 测试方案

### 9.1 单元测试

**后端 (pytest)**:
```python
# tests/test_trading_engine.py

import pytest
from services.trading_engine import TradingEngine

@pytest.mark.asyncio
async def test_execute_buy_success():
    """测试买入交易成功"""
    engine = TradingEngine()
    result = await engine.execute_buy(
        account_id=1,
        asset_symbol="600000",
        quantity=100,
        price=12.50
    )
    assert result["trade_type"] == "BUY"
    assert result["total_amount"] == 1250.00

@pytest.mark.asyncio
async def test_execute_buy_insufficient_balance():
    """测试余额不足"""
    engine = TradingEngine()
    with pytest.raises(InsufficientBalanceError):
        await engine.execute_buy(
            account_id=1,
            asset_symbol="600000",
            quantity=10000,
            price=12.50
        )
```

### 9.2 集成测试

**API 测试**:
```python
# tests/test_api.py

from fastapi.testclient import TestClient
from main import app

client = TestClient(app)

def test_create_account():
    """测试创建账户"""
    response = client.post("/api/v1/accounts", json={
        "user_id": 1,
        "account_name": "测试账户",
        "initial_balance": 100000.00
    })
    assert response.status_code == 201
    assert response.json()["success"] == True

def test_buy_trade():
    """测试买入交易"""
    response = client.post("/api/v1/trades/buy", json={
        "account_id": 1,
        "asset_symbol": "600000",
        "quantity": 100,
        "price": 12.50
    })
    assert response.status_code == 200
    assert response.json()["data"]["trade_type"] == "BUY"
```

### 9.3 前端测试

**组件测试 (Jest + React Testing Library)**:
```typescript
// __tests__/TradeForm.test.tsx

import { render, screen, fireEvent } from '@testing-library/react';
import TradeForm from '@/components/TradeForm';

test('renders buy trade form', () => {
  render(<TradeForm tradeType="BUY" />);
  expect(screen.getByText('买入')).toBeInTheDocument();
});

test('validates quantity input', async () => {
  render(<TradeForm tradeType="BUY" />);
  const quantityInput = screen.getByLabelText('数量');
  fireEvent.change(quantityInput, { target: { value: '-10' } });
  expect(await screen.findByText('数量必须大于0')).toBeInTheDocument();
});
```

### 9.4 性能测试

使用 **Locust** 进行负载测试:
```python
# locustfile.py

from locust import HttpUser, task, between

class TradingUser(HttpUser):
    wait_time = between(1, 3)

    @task(3)
    def get_holdings(self):
        self.client.get("/api/v1/holdings/1")

    @task(1)
    def execute_trade(self):
        self.client.post("/api/v1/trades/buy", json={
            "account_id": 1,
            "asset_symbol": "600000",
            "quantity": 10,
            "price": 12.50
        })
```

### 9.5 测试数据准备

**数据库 Seed 脚本**:
```python
# scripts/seed_data.py

async def seed_test_data():
    """生成测试数据"""
    # 创建测试用户
    user = await User.create(
        username="testuser",
        email="test@example.com",
        password_hash="hashed_password"
    )

    # 创建测试账户
    account = await SimAccount.create(
        user_id=user.id,
        account_name="测试账户",
        initial_balance=100000.00,
        current_balance=100000.00
    )

    # 创建测试资产
    assets = [
        {"symbol": "600000", "name": "浦发银行", "asset_type": "股票"},
        {"symbol": "600036", "name": "招商银行", "asset_type": "股票"},
        {"symbol": "000001", "name": "平安银行", "asset_type": "股票"},
    ]

    for asset_data in assets:
        await Asset.create(**asset_data)
```

---

## 10. 风险控制

### 10.1 技术风险

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| 精度丢失 | 资金计算错误 | 使用 Decimal 类型，禁止 float |
| 并发问题 | 数据不一致 | 数据库事务 + 行级锁 |
| 性能瓶颈 | 响应慢 | Redis 缓存 + 数据库索引优化 |
| 数据库宕机 | 服务不可用 | 主从复制 + 定期备份 |

### 10.2 业务风险

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| 余额为负 | 数据错误 | 交易前严格验证 + 数据库约束 |
| 持仓数量错误 | 计算错误 | 事务保证原子性 + 定期数据校验 |
| 重复交易 | 资金错误 | 幂等性设计 + 交易ID去重 |
| 行情数据延迟 | 用户体验差 | 显示数据时间戳 + 免责声明 |

### 10.3 合规风险

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| 被误认为真实交易平台 | 法律风险 | 明确标注"模拟"字样 |
| 用户投诉 | 声誉风险 | 完善用户协议 + 风险提示 |
| 数据泄露 | 隐私风险 | 数据加密 + 访问控制 |

### 10.4 数据一致性保障

**每日数据校验脚本**:
```python
async def verify_data_consistency():
    """验证数据一致性"""
    accounts = await SimAccount.all()

    for account in accounts:
        # 1. 计算持仓总市值
        holdings = await SimHolding.filter(account_id=account.id)
        holdings_value = sum(h.quantity * h.avg_price for h in holdings)

        # 2. 计算所有交易的资金流水
        trades = await SimTrade.filter(account_id=account.id)
        buy_total = sum(t.quantity * t.price for t in trades if t.trade_type == "BUY")
        sell_total = sum(t.quantity * t.price for t in trades if t.trade_type == "SELL")

        # 3. 验证等式: 初始资金 - 买入金额 + 卖出金额 + 持仓市值 ≈ 当前总资产
        expected_total = account.initial_balance - buy_total + sell_total + holdings_value
        actual_total = account.current_balance + holdings_value

        if abs(expected_total - actual_total) > 0.01:
            logger.error(f"账户 {account.id} 数据不一致: 预期 {expected_total}, 实际 {actual_total}")
```

---

## 11. 后续迭代方向

### 11.1 短期优化 (Month 3)
- [ ] 实时价格推送 (WebSocket)
- [ ] 简单 AI 交易建议
- [ ] 持仓盈亏图表可视化
- [ ] 移动端适配优化

### 11.2 中期扩展 (Month 4-6)
- [ ] 限价单、止损单
- [ ] 回测功能
- [ ] 高级图表集成 (TradingView)
- [ ] 社交功能集成 (分享交易)

### 11.3 长期规划 (Month 6+)
- [ ] 多账户对比
- [ ] AI 策略推荐
- [ ] 期货、期权模拟
- [ ] B端 API 开放

---

## 附录

### A. 数据字典

详见数据库设计部分

### B. API 接口汇总

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建账户 | POST | /api/v1/accounts | 创建模拟账户 |
| 获取账户 | GET | /api/v1/accounts/{id} | 获取账户详情 |
| 用户账户列表 | GET | /api/v1/accounts/user/{id} | 获取用户所有账户 |
| 重置账户 | PUT | /api/v1/accounts/{id}/reset | 重置账户 |
| 买入交易 | POST | /api/v1/trades/buy | 执行买入 |
| 卖出交易 | POST | /api/v1/trades/sell | 执行卖出 |
| 交易历史 | GET | /api/v1/trades/{account_id} | 获取交易记录 |
| 持仓列表 | GET | /api/v1/holdings/{account_id} | 获取持仓 |
| 持仓汇总 | GET | /api/v1/holdings/{account_id}/summary | 持仓统计 |
| 资产列表 | GET | /api/v1/assets | 可交易资产 |
| 资产详情 | GET | /api/v1/assets/{symbol} | 资产信息 |
| 实时价格 | GET | /api/v1/assets/{symbol}/price | 获取价格 |

### C. 错误处理示例

```python
# backend/exceptions.py

class TradingException(Exception):
    """交易异常基类"""
    def __init__(self, message: str, code: str):
        self.message = message
        self.code = code
        super().__init__(self.message)

class InsufficientBalanceError(TradingException):
    def __init__(self, message: str):
        super().__init__(message, "INSUFFICIENT_BALANCE")

class InsufficientHoldingsError(TradingException):
    def __init__(self, message: str):
        super().__init__(message, "INSUFFICIENT_HOLDINGS")

# 全局异常处理器
@app.exception_handler(TradingException)
async def trading_exception_handler(request: Request, exc: TradingException):
    return JSONResponse(
        status_code=400,
        content={
            "success": False,
            "error": {
                "code": exc.code,
                "message": exc.message
            }
        }
    )
```

---

## 12. 实现状态总结

### 12.1 已完成功能 ✅

#### 后端核心功能
1. **数据库设计和模型** ✅
   - ✅ Tortoise-ORM 集成和配置
   - ✅ 完整的数据模型（User, SimAccount, SimTrade, SimHolding, Asset）
   - ✅ 外键关系和索引优化
   - ✅ Decimal 精度处理

2. **账户管理服务** ✅
   - ✅ 创建账户（POST `/api/v1/accounts`）
   - ✅ 查询账户详情（GET `/api/v1/accounts/{account_id}`）
   - ✅ 查询用户账户列表（GET `/api/v1/accounts/user/{user_id}`）
   - ✅ 重置账户（PUT `/api/v1/accounts/{account_id}/reset`）
   - ✅ 更新账户（PATCH `/api/v1/accounts/{account_id}`）
   - ✅ 删除账户（DELETE `/api/v1/accounts/{account_id}`）
   - ✅ 账户总资产和盈亏计算

3. **交易引擎核心** ✅
   - ✅ 买入交易逻辑（`TradeService.buy_asset()`）
     - 余额验证
     - 持仓自动创建/更新
     - 平均成本价计算
     - 数据库事务保证原子性
   - ✅ 卖出交易逻辑（`TradeService.sell_asset()`）
     - 持仓验证
     - 持仓自动更新/删除
     - 盈亏计算
   - ✅ 交易历史查询（支持筛选和分页）

4. **持仓管理服务** ✅
   - ✅ 持仓列表查询（GET `/api/v1/holdings/{account_id}`）
   - ✅ 持仓汇总统计（GET `/api/v1/holdings/{account_id}/summary`）
   - ✅ 成本、市值、盈亏自动计算
   - ✅ 资产配置分析

5. **资产管理服务** ✅
   - ✅ 资产列表查询（支持搜索和筛选）
   - ✅ 资产详情查询
   - ✅ K线数据API（GET `/api/v1/klines/{symbol}`）

6. **异常处理机制** ✅
   - ✅ 自定义业务异常类（`exceptions.py`）
     - InsufficientBalanceError（余额不足）
     - InsufficientHoldingsError（持仓不足）
     - AccountNotFoundError（账户不存在）
     - AssetNotFoundError（资产不存在）
     - 等等...
   - ✅ 统一的错误响应格式

7. **数据验证** ✅
   - ✅ Pydantic 请求模型验证
   - ✅ 业务逻辑验证（余额、持仓、数量等）

8. **测试数据** ✅
   - ✅ 测试数据初始化脚本（`backend/scripts/init_test_data.py`）

#### 前端核心功能
1. **交易界面组件** ✅
   - ✅ TradePanel - 买入/卖出交易面板
   - ✅ TradeConfirmDialog - 交易确认对话框
   - ✅ TradeHistory - 交易历史组件
   - ✅ 表单验证和实时计算
   - ✅ 错误消息显示和成功反馈

2. **状态管理** ✅
   - ✅ Zustand 状态管理（tradingStore）
   - ✅ 交易执行逻辑（useTrade Hook）

3. **UI/UX** ✅
   - ✅ 买入/卖出Tab切换
   - ✅ 实时金额计算
   - ✅ 余额和持仓显示
   - ✅ 成功/错误消息提示

---

### 12.2 待完善功能 📝

#### 后端待完善
1. **测试** ⚠️
   - ❌ 单元测试（pytest）
   - ❌ 集成测试
   - ❌ 性能测试（Locust）
   - ❌ 数据一致性验证脚本

2. **实时价格** ⚠️
   - ⚠️ 当前使用 Asset 表的静态价格
   - ❌ 对接真实行情数据源
   - ❌ WebSocket 实时推送
   - ❌ Redis 价格缓存

3. **高级功能** ❌
   - ❌ 限价单、止损单
   - ❌ 交易手续费计算
   - ❌ 撤单功能
   - ❌ AI 交易建议

4. **监控和日志** ⚠️
   - ❌ 交易日志记录
   - ❌ 性能监控
   - ❌ 异常告警

#### 前端待完善
1. **页面完整性** ⚠️
   - ❌ 完整的页面路由结构
   - ❌ 账户总览页面
   - ❌ 持仓列表页面（完整版）
   - ❌ 交易历史页面（完整版）
   - ❌ 账户管理页面

2. **图表可视化** ❌
   - ❌ K线图集成
   - ❌ 持仓饼图
   - ❌ 收益曲线图
   - ❌ 技术指标

3. **用户体验** ⚠️
   - ❌ 加载状态和骨架屏
   - ❌ 数据刷新机制
   - ❌ 响应式设计优化
   - ❌ 快捷键支持

4. **搜索功能** ⚠️
   - ❌ 股票搜索自动完成
   - ❌ 搜索历史记录
   - ❌ 热门股票推荐

---

### 12.3 技术亮点 ⭐

1. **数据精度保证**
   - 全面使用 Python `Decimal` 类型
   - 避免浮点数精度损失
   - 确保资金计算100%准确

2. **事务一致性**
   - 使用 Tortoise-ORM 的 `in_transaction()`
   - 确保交易操作的原子性
   - 防止并发问题

3. **平均成本价计算**
   - 买入时自动计算加权平均成本价
   - 公式：`new_avg_price = (old_cost + new_cost) / new_quantity`

4. **持仓自动管理**
   - 买入时自动创建或更新持仓
   - 卖出时自动减少或删除持仓
   - 数量为0自动清理记录

5. **完善的错误处理**
   - 自定义业务异常体系
   - 统一的错误响应格式
   - 友好的错误消息

6. **API 文档自动生成**
   - FastAPI 自动生成 Swagger UI
   - Pydantic 模型自动生成文档示例
   - 实时在线测试

---

### 12.4 下一步计划 🚀

#### 短期目标（1-2周）
1. ✅ 完成前端完整页面开发
2. ✅ 实现数据实时刷新
3. ✅ 添加基础图表（持仓饼图、收益曲线）
4. ✅ 完善错误处理和用户反馈
5. ✅ 编写基础单元测试

#### 中期目标（1个月）
1. ✅ 对接真实行情数据
2. ✅ 实现 WebSocket 实时推送
3. ✅ 集成 TradingView 图表库
4. ✅ 实现高级订单类型
5. ✅ 添加交易手续费

#### 长期目标（2-3个月）
1. ✅ AI 交易建议功能
2. ✅ 回测系统
3. ✅ 社交功能集成（分享交易）
4. ✅ 移动端适配
5. ✅ 性能优化和压测

---

## 文档更新日志

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|---------|
| v1.0 | 2025-10-23 | Claude Code | 初始版本，完整设计方案 |
| v1.1 | 2025-10-27 | Claude Code | 更新实现状态，标注已完成功能 |

---

**🎯 MVP 核心功能已基本完成！继续完善前端界面和图表功能！**
