# 图表工具开发路线图

> 专业级K线图表工具开发计划 - 对标 TradingView

---

## 🎯 总体目标

打造一个功能强大、性能优异、用户体验出色的专业级股票图表分析工具。

### 核心指标
- **技术指标**：50+ 常用和高级指标
- **绘图工具**：20+ 专业分析工具
- **图表类型**：5+ 种K线展示方式
- **性能目标**：百万数据点流畅渲染
- **用户体验**：< 100ms 交互响应

---

## 🔥 第零阶段：核心体验优化（Week 2，本周）

### 目标：完成3个最高优先级的核心功能

#### 0.1 K线倒计时功能 ⏰
- [ ] **实时倒计时显示**
  - 文件：`frontend/src/components/trading/CandlestickChart.tsx`
  - 在最后一根K线上方显示倒计时
  - 格式：分钟级（MM:SS），日K级（HH:MM:SS）
  - 实时刷新（每秒更新）
  - 与K线位置对齐
  - 倒计时结束后自动请求新数据

- [ ] **倒计时组件**
  - 文件：`frontend/src/components/trading/KlineCountdown.tsx`
  - 计算当前K线剩余时间
  - 支持所有时间周期（5m/15m/30m/60m/120m/1d/1w/1M）
  - 使用 lightweight-charts 的 Marker 或自定义 Primitive

#### 0.2 动态数据加载优化 🚀
- [ ] **智能数据加载策略**
  - 文件：`frontend/src/hooks/useChartData.ts`（新建）
  - 监听图表可见范围变化
  - 左滑动时：加载历史数据（向前）
  - 右滑动时：加载最新数据（向后）
  - 缩放时：根据时间范围调整数据密度

- [ ] **性能优化**
  - 防抖处理（避免频繁请求）
  - 数据缓存（已加载的数据不重复请求）
  - 分片加载（大数据量分批渲染）
  - 虚拟滚动（只渲染可见区域）
  - 请求合并（相近时间范围合并请求）

- [ ] **加载状态指示**
  - 左侧加载更多提示
  - 右侧加载更多提示
  - 加载中动画
  - 已加载全部数据提示

#### 0.3 线形图（Line Chart）📈
- [ ] **线形图实现**
  - 文件：`frontend/src/components/trading/LineChart.tsx`（可选新建）
  - 或直接在 CandlestickChart 中切换
  - 只显示收盘价连线
  - 颜色：单色或渐变
  - 支持所有技术指标（EMA、MACD 等）

- [ ] **图表类型切换器**
  - 工具栏添加图表类型选择
  - 蜡烛图 ⇄ 线形图
  - 平滑切换，保留缩放位置
  - 保存用户偏好

### 技术要点

**倒计时实现方案：**
```typescript
// 计算K线剩余时间
function calculateTimeRemaining(interval: string, lastBarTime: number): number {
  const now = Date.now() / 1000; // 转为秒
  const intervalSeconds = getIntervalSeconds(interval); // 5m=300, 1d=86400
  const elapsed = now - lastBarTime;
  const remaining = intervalSeconds - (elapsed % intervalSeconds);
  return remaining;
}

// 使用 lightweight-charts 的 Custom Price Line 或 Marker
chart.addPriceLine({
  price: lastPrice,
  title: formatTime(timeRemaining),
  // ...
});
```

**动态加载方案：**
```typescript
// 监听时间轴可见范围
chart.timeScale().subscribeVisibleLogicalRangeChange((range) => {
  if (range.from < loadedRange.from + buffer) {
    loadHistoricalData(); // 加载历史数据
  }
  if (range.to > loadedRange.to - buffer) {
    loadLatestData(); // 加载最新数据
  }
});

// 数据缓存策略
const dataCache = new Map<string, KlineData[]>(); // key: symbol_interval_startTime_endTime
```

### 交付标准
- ✅ 倒计时精确到秒，无明显延迟
- ✅ 滑动加载流畅，无卡顿（< 100ms）
- ✅ 数据缓存命中率 > 80%
- ✅ 线形图与蜡烛图无缝切换
- ✅ 支持所有时间周期

---

## 📊 第一阶段：核心技术指标（Week 1-2）

### 目标：完成 10 个最常用技术指标

#### 1.1 已完成 ✅
- [x] **EMA（指数移动平均线）**
  - 支持 6 个周期（5/10/20/30/60/120）
  - 快速预设（短期/中期/长期）
  - 颜色编码
  - 主图叠加

#### 1.2 已完成 ✅
- [x] **MACD（指数平滑异同移动平均线）**
  - 文件：`frontend/src/lib/indicators/macd.ts`
  - 子图显示
  - DIFF 线（蓝色）
  - DEA 线（橙色）
  - MACD 柱状图（红绿）
  - 参数：(12, 26, 9)
  - 参数预设（经典/快速/慢速）

- [ ] **RSI（相对强弱指标）**
  - 文件：`frontend/src/lib/indicators/rsi.ts`
  - 子图显示
  - RSI 曲线（紫色）
  - 超买线 70（红色虚线）
  - 超卖线 30（绿色虚线）
  - 参数：14 周期
  - 支持多周期叠加（6/12/24）

- [ ] **KDJ 指标**
  - 文件：`frontend/src/lib/indicators/kdj.ts`
  - 子图显示
  - K 线（白色）
  - D 线（黄色）
  - J 线（紫色）
  - 超买区 80+（浅红色背景）
  - 超卖区 20-（浅绿色背景）
  - 参数：(9, 3, 3)

- [ ] **MA（简单移动平均线）**
  - 文件：`frontend/src/lib/indicators/ma.ts`
  - 主图叠加
  - 支持 6 个周期（5/10/20/30/60/120）
  - 与 EMA 共用配置面板
  - 可同时显示 MA 和 EMA
  - 线型区分（MA 实线，EMA 细线）

- [ ] **布林带（Bollinger Bands）**
  - 文件：`frontend/src/lib/indicators/bollinger.ts`
  - 主图叠加
  - 上轨（红色虚线）
  - 中轨（黄色实线，即 MA）
  - 下轨（绿色虚线）
  - 填充区域（半透明）
  - 参数：(20, 2) - 周期和标准差倍数

#### 1.3 成交量增强
- [ ] **VOL-MA（成交量移动平均线）**
  - 在现有成交量子图上叠加
  - MA5（白色）
  - MA10（黄色）
  - 与成交量柱同一坐标系

#### 1.4 子图管理系统
- [ ] **子图容器组件**
  - 文件：`frontend/src/components/trading/SubChart.tsx`
  - 支持添加/删除子图
  - 子图高度拖拽调整
  - 子图顺序调整
  - 最多 4 个子图

### 交付标准
- ✅ 每个指标独立的计算模块
- ✅ 统一的配置面板 UI
- ✅ 参数可调节
- ✅ 颜色可自定义
- ✅ 性能测试通过（10万数据点 < 100ms）

---

## 🎨 第二阶段：绘图工具（Week 3-4）

### 目标：实现 8 个基础绘图工具

#### 2.1 基础工具
- [ ] **趋势线（Trend Line）**
  - 两点确定一条直线
  - 支持延长线
  - 可调整端点
  - 显示角度和长度

- [ ] **水平线（Horizontal Line）**
  - 单击确定价格
  - 全时间轴延伸
  - 标注价格值
  - 用于标记支撑/阻力位

- [ ] **垂直线（Vertical Line）**
  - 单击确定时间
  - 全价格轴延伸
  - 标注日期/时间
  - 用于标记重要事件

- [ ] **射线（Ray）**
  - 两点确定，单向延伸
  - 支持角度调整

#### 2.2 几何图形
- [ ] **矩形（Rectangle）**
  - 两点对角确定
  - 填充颜色可选
  - 边框样式可选
  - 用于标记价格区间

- [ ] **平行通道（Parallel Channel）**
  - 趋势线 + 平行线
  - 自动计算通道宽度
  - 用于通道交易

#### 2.3 文字标注
- [ ] **文本标签（Text Label）**
  - 单击放置
  - 自由编辑内容
  - 字体大小/颜色可调
  - 背景框可选

- [ ] **价格标签（Price Label）**
  - 自动显示当前价格
  - 颜色随涨跌变化

#### 2.4 绘图管理
- [ ] **绘图工具栏**
  - 文件：`frontend/src/components/trading/DrawingToolbar.tsx`
  - 工具选择按钮
  - 激活状态指示
  - 取消当前绘图

- [ ] **绘图对象管理**
  - 绘图列表侧边栏
  - 显示/隐藏切换
  - 锁定/解锁
  - 删除操作
  - 修改属性（颜色、线宽、样式）

### 交付标准
- ✅ 所有绘图支持拖拽移动
- ✅ 所有绘图支持调整大小
- ✅ 绘图数据可保存和恢复
- ✅ 性能：100 个绘图对象流畅交互

---

## 📈 第三阶段：图表类型扩展（Week 5）

### 目标：支持 5 种图表类型

#### 3.1 图表类型
- [ ] **美国线（OHLC Bar Chart）**
  - 开高低收柱状图
  - 适合密集数据

- [ ] **山峰图（Area Chart）**
  - 收盘价折线图 + 填充
  - 渐变色效果
  - 适合趋势展示

- [ ] **Heiken Ashi 蜡烛图**
  - 平滑的蜡烛图
  - 过滤噪音
  - 更清晰的趋势

- [ ] **线形图（Line Chart）**
  - 简洁的收盘价连线
  - 适合长周期

- [ ] **Renko 砖形图**（可选）
  - 固定价格变动的砖块
  - 忽略时间因素

#### 3.2 图表类型切换器
- [ ] **类型选择器组件**
  - 下拉菜单或按钮组
  - 图标 + 文字
  - 保存用户偏好

### 交付标准
- ✅ 所有类型支持相同的时间周期
- ✅ 类型切换流畅无闪烁
- ✅ 所有技术指标兼容各类型

---

## 🔧 第四阶段：高级技术指标（Week 6-7）

### 目标：完成 10 个高级指标

#### 4.1 量价指标
- [ ] **OBV（能量潮指标）**
  - 文件：`frontend/src/lib/indicators/obv.ts`
  - 子图显示
  - OBV 累积曲线
  - OBV-MA 叠加

- [ ] **VWAP（成交量加权平均价）**
  - 主图叠加
  - 实时计算
  - 日内重置

#### 4.2 波动率指标
- [ ] **ATR（真实波幅）**
  - 文件：`frontend/src/lib/indicators/atr.ts`
  - 子图显示
  - ATR 曲线
  - 参数：14 周期

- [ ] **标准差（Standard Deviation）**
  - 子图显示
  - 波动率分析

#### 4.3 趋势指标
- [ ] **DMI（趋向指标）**
  - 文件：`frontend/src/lib/indicators/dmi.ts`
  - 子图显示
  - +DI（绿色）
  - -DI（红色）
  - ADX（黄色）
  - ADXR（白色，可选）

- [ ] **SAR（抛物线指标）**
  - 主图叠加
  - 圆点显示
  - 多空转换

- [ ] **一目均衡图（Ichimoku）**
  - 主图叠加
  - 转换线、基准线
  - 先行带 A/B
  - 延迟线

#### 4.4 震荡指标
- [ ] **CCI（顺势指标）**
  - 文件：`frontend/src/lib/indicators/cci.ts`
  - 子图显示
  - CCI 曲线
  - ±100 水平线

- [ ] **威廉指标（Williams %R）**
  - 子图显示
  - %R 曲线
  - -20/-80 水平线

- [ ] **STOCH（随机指标）**
  - 子图显示
  - %K 和 %D 线
  - 超买超卖区间

#### 4.5 其他指标
- [ ] **BIAS（乖离率）**
  - 子图显示
  - 多周期 BIAS
  - 零轴水平线

### 交付标准
- ✅ 所有指标有完整的参数说明
- ✅ 提供参数调节界面
- ✅ 默认参数符合市场习惯

---

## ⚙️ 第五阶段：用户体验优化（Week 8-9）

### 目标：提升交互体验和性能

#### 5.1 技术指标管理器
- [ ] **指标管理面板**
  - 文件：`frontend/src/components/trading/IndicatorManager.tsx`
  - 指标分类（趋势/震荡/量价/波动）
  - 搜索和筛选
  - 拖拽添加到图表
  - 常用指标收藏
  - 指标模板保存

#### 5.2 图表设置保存
- [ ] **配置持久化**
  - LocalStorage 保存用户配置
  - 指标组合保存
  - 颜色主题保存
  - 布局保存
  - 导入/导出配置文件

#### 5.3 快捷键系统
- [ ] **快捷键配置**
  - 文件：`frontend/src/hooks/useKeyboard.ts`
  - 常用操作快捷键
    - `Space` - 十字光标
    - `Esc` - 取消当前操作
    - `Delete` - 删除选中对象
    - `Ctrl+Z` - 撤销
    - `Ctrl+Y` - 重做
    - `Ctrl+S` - 保存配置
    - `Ctrl+D` - 删除所有绘图
    - `1-9` - 快速切换时间周期
  - 快捷键帮助文档（`?` 键打开）

#### 5.4 性能优化
- [ ] **渲染优化**
  - 虚拟滚动优化
  - 指标计算 Web Worker
  - 防抖和节流
  - Canvas 分层渲染

- [ ] **数据优化**
  - 数据分页加载
  - 增量更新
  - 内存管理

#### 5.5 响应式设计
- [ ] **自适应布局**
  - 桌面端（≥1920px）完整布局
  - 笔记本（1366px-1920px）紧凑布局
  - 平板（768px-1366px）移动优化
  - 手机（<768px）极简布局

### 交付标准
- ✅ 所有配置自动保存
- ✅ 快捷键无冲突
- ✅ 百万数据点流畅交互
- ✅ 移动端基本可用

---

## 🎯 第六阶段：高级绘图工具（Week 10-11）

### 目标：完成专业级绘图工具

#### 6.1 斐波那契工具
- [ ] **斐波那契回撤（Fibonacci Retracement）**
  - 两点确定
  - 自动计算回撤位（23.6%, 38.2%, 50%, 61.8%, 100%）
  - 水平线和标签
  - 颜色编码

- [ ] **斐波那契扩展（Fibonacci Extension）**
  - 三点确定
  - 扩展位（161.8%, 261.8%, 423.6%）
  - 用于预测目标位

- [ ] **斐波那契扇形（Fibonacci Fan）**
  - 两点确定
  - 扇形线（38.2%, 50%, 61.8%）

- [ ] **斐波那契时间线（Fibonacci Time Zones）**
  - 垂直时间线
  - 斐波那契数列间隔

#### 6.2 高级几何工具
- [ ] **三角形（Triangle）**
  - 三点确定
  - 填充可选

- [ ] **圆形（Circle）**
  - 中心点 + 半径
  - 用于周期分析

- [ ] **椭圆（Ellipse）**
  - 两轴确定

- [ ] **头肩顶/底模式**
  - 辅助识别经典形态
  - 自动标注

#### 6.3 测量工具
- [ ] **测量工具（Measure）**
  - 两点之间：
    - 价格变化（绝对值 + 百分比）
    - 时间跨度
    - 角度
    - 距离

- [ ] **价格范围（Price Range）**
  - 统计范围内：
    - 最高价/最低价
    - 平均价
    - 振幅

#### 6.4 标注工具
- [ ] **箭头标注**
  - 上升箭头（看涨）
  - 下降箭头（看跌）
  - 预设颜色

- [ ] **图标标记**
  - 星标（重要位置）
  - 旗帜（事件标记）
  - 笑脸/哭脸（情绪）
  - 警告标志

- [ ] **高级文本**
  - 富文本编辑
  - 链接支持
  - 背景样式

### 交付标准
- ✅ 所有工具支持磁吸功能
- ✅ 绘图对象可分组管理
- ✅ 支持模板保存和复用

---

## 📐 第七阶段：多图表布局（Week 12）

### 目标：专业级多窗口分析

#### 7.1 布局系统
- [ ] **布局组件**
  - 文件：`frontend/src/components/trading/ChartLayout.tsx`
  - 预设布局：
    - 1×1（单图）
    - 2×1（左右分屏）
    - 1×2（上下分屏）
    - 2×2（四宫格）
    - 自定义布局
  - 拖拽分隔线调整比例
  - 布局保存和恢复

#### 7.2 图表同步
- [ ] **同步功能**
  - 时间轴同步（所有图表同一时间范围）
  - 十字光标同步（位置联动）
  - 缩放同步（同时缩放）
  - 可独立控制每个图表

#### 7.3 多图表管理
- [ ] **图表切换**
  - 每个窗口独立股票
  - 每个窗口独立指标配置
  - 快速切换预设组合

### 交付标准
- ✅ 最多支持 8 个图表窗口
- ✅ 布局切换流畅
- ✅ 所有功能在多图表模式正常工作

---

## 🎨 第八阶段：主题和样式（Week 13）

### 目标：美观且专业的视觉体验

#### 8.1 主题系统
- [ ] **内置主题**
  - Dark Mode（深色，默认）
  - Light Mode（浅色）
  - Professional（专业版，黑金配色）
  - Colorful（彩色，适合演示）

- [ ] **自定义主题**
  - 背景色
  - 网格线颜色
  - 文字颜色
  - K线颜色（涨/跌）
  - 成交量颜色
  - 指标颜色方案

#### 8.2 图表导出
- [ ] **截图功能**
  - 当前视图截图
  - 高清截图（2x, 4x）
  - 包含/排除绘图
  - 水印设置

- [ ] **图片分享**
  - 一键复制到剪贴板
  - 下载为 PNG/JPG
  - 社交媒体分享（预留接口）

### 交付标准
- ✅ 主题切换实时生效
- ✅ 所有UI组件适配主题
- ✅ 截图质量高清

---

## 🔍 第九阶段：高级功能（Week 14-15）

### 目标：差异化竞争力

#### 9.1 指标对比
- [ ] **多指标叠加对比**
  - 同一子图显示多个指标
  - 双Y轴支持
  - 颜色区分

#### 9.2 历史回放
- [ ] **K线回放功能**
  - 从历史某一天开始播放
  - 速度控制（1x, 2x, 5x, 10x）
  - 暂停/继续
  - 用于复盘学习

#### 9.3 模式识别
- [ ] **K线形态识别**
  - 经典形态自动识别：
    - 锤子线、吊颈线
    - 早晨之星、黄昏之星
    - 十字星
    - 吞没形态
  - 形态标注和提示

#### 9.4 智能辅助线
- [ ] **自动支撑阻力位**
  - 算法识别关键价位
  - 自动绘制水平线
  - 标注触及次数

- [ ] **自动趋势线**
  - 识别上升/下降趋势
  - 绘制趋势线
  - 突破提醒

### 交付标准
- ✅ 识别准确率 > 80%
- ✅ 性能不受影响
- ✅ 可手动调整和关闭

---

## 📊 成功指标

### 功能完整度
- ✅ 50+ 技术指标
- ✅ 20+ 绘图工具
- ✅ 5+ 图表类型
- ✅ 多图表布局
- ✅ 完整的用户配置系统

### 性能指标
- ✅ 100万数据点流畅渲染（60fps）
- ✅ 交互响应时间 < 100ms
- ✅ 指标计算时间 < 50ms
- ✅ 内存占用 < 500MB

### 用户体验
- ✅ 学习曲线平缓（5分钟上手）
- ✅ 快捷键支持（提升效率）
- ✅ 配置自动保存（无需手动）
- ✅ 移动端基本可用

### 代码质量
- ✅ TypeScript 严格模式
- ✅ 单元测试覆盖率 > 80%
- ✅ 代码注释完整
- ✅ 性能监控和优化

---

## 📅 总体时间规划

| 阶段 | 周次 | 主要内容 | 交付物 |
|------|------|----------|--------|
| 第零阶段 🔥 | Week 2 | 核心体验优化 | 倒计时 + 动态加载 + 线形图 |
| 第一阶段 | Week 1-2 | 核心技术指标 | EMA ✅ + MACD ✅ + RSI + KDJ |
| 第二阶段 | Week 3-4 | 绘图工具 | 8个基础工具 |
| 第三阶段 | Week 5 | 图表类型 | 美国线、山峰图等 |
| 第四阶段 | Week 6-7 | 高级指标 | 10个高级指标 |
| 第五阶段 | Week 8-9 | 用户体验 | 配置系统 + 快捷键 |
| 第六阶段 | Week 10-11 | 高级绘图 | 斐波那契等工具 |
| 第七阶段 | Week 12 | 多图表布局 | 8窗口支持 |
| 第八阶段 | Week 13 | 主题系统 | 4套主题 + 导出 |
| 第九阶段 | Week 14-15 | 高级功能 | 回放 + 识别 |

**预计完成时间：15周（约3.5个月）**

---

## 🚀 下一步行动

### Week 1 已完成 ✅
- [x] EMA 指标完成
- [x] MACD 指标完成

### 本周任务（Week 2）🔥 最高优先级

#### 1. K线倒计时功能（优先级 P0）
- [ ] 创建倒计时工具函数
  - 文件：`frontend/src/lib/utils/timeUtils.ts`
  - 计算各时间周期的剩余时间
  - 格式化显示（MM:SS 或 HH:MM:SS）
- [ ] 在 CandlestickChart 中集成倒计时
  - 使用 `setInterval` 每秒更新
  - 在最后一根K线上方显示
  - 倒计时归零时触发数据刷新
- [ ] 测试所有时间周期的倒计时准确性

#### 2. 动态数据加载优化（优先级 P0）
- [ ] 创建数据加载 Hook
  - 文件：`frontend/src/hooks/useChartData.ts`
  - 实现数据缓存逻辑
  - 监听可见范围变化
- [ ] 实现智能加载策略
  - 左滑加载历史数据
  - 右滑加载最新数据
  - 防抖优化（200ms）
- [ ] 添加加载状态指示
  - Loading Spinner
  - 已加载全部数据提示
- [ ] 性能测试和优化
  - 测试滑动流畅度
  - 优化缓存命中率

#### 3. 线形图实现（优先级 P0）
- [ ] 在 CandlestickChart 中添加图表类型切换
  - 添加状态：`chartType: 'candlestick' | 'line'`
  - 工具栏添加切换按钮
- [ ] 实现线形图渲染
  - 使用 `addLineSeries` 显示收盘价
  - 保留所有技术指标
  - 平滑切换动画
- [ ] 保存用户偏好
  - LocalStorage 存储
  - 下次打开自动恢复

### 下周任务（Week 3）
- RSI 指标
- KDJ 指标
- 布林带指标

---

*最后更新：2025-10-27*
