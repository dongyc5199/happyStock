# 模拟市场价格生成规范（修订版）

> 目标：在**统计上逼真**而非只“看起来像”的前提下，生成市场—板块—个股的联动价格路径，满足日内涨跌停约束，支持分钟级或秒级步长，易于调参与验证。

---

## 1. 设计原则

1. **时间尺度统一**：以“日”为基准。所有漂移（趋势）与波动（σ）先换算到**日尺度**，再按步长用 `dt_day` 折算。  
2. **相关性来自共享随机冲击**：市场与板块的相关由**相关正态增量**提供，而非靠“趋势相加”。  
3. **对数收益建模**：用 log-return 累加，价格通过 `P_{t+Δ} = P_t · exp(r)` 生成。  
4. **监管约束优先**：涨跌停以“相对昨收的日带”为准，任何盘中路径不得越带。  
5. **可校准、可回归**：所有关键统计量（波动、β、相关）可通过最小二乘或简易搜索回到目标区间。  
6. **可扩展**：可按需叠加波动聚集（EWMA/GARCH）、日内 U 形波动、事件冲击等模块。

---

## 2. 总体结构

- 三层因子：**市场 m**、**板块 s**、**个股 i**。  
- 每步对数收益（以日为基准）：

\[
\begin{aligned}
r_m &= \mu_m\,dt + \sigma_{m,\mathrm{day}}\sqrt{dt}\,Z_m \\
r_s &= \sigma_{s,\mathrm{day}}\sqrt{dt}\,Z_s \\
r_i &= \sigma_{i,\mathrm{day}}\sqrt{dt}\,Z_i \\
r^{(k)} &= w_m\,\beta_m^{(k)}\,r_m + w_s\,\beta_s^{(k)}\,r_s + w_i\,r_i
\end{aligned}
\]

其中 \(Z_m,Z_s,Z_i \sim \mathcal{N}(0,1)\)，并令 \(\mathrm{Corr}(Z_m,Z_s)=\rho_{ms}\)、\(Z_i\) 独立。  
价格更新：\(P_{t+\Delta}^{\mathrm{raw}} = P_t\cdot e^{r^{(k)}}\)。

---

## 3. 时间与单位

- 交易日长度：以 240 分钟为例（可配置）。  
- 步长：
  - 分钟级：1 分钟/步 → 一天 240 步 → `dt = 1/240`  
  - 秒级示例：3 秒/步 → 一天 4800 步 → `dt = 1/4800`  
- 年/日换算：
  - \(\sigma_{\mathrm{day}} = \sigma_{\mathrm{annual}} / \sqrt{250}\)  
  - \(\mu_{\mathrm{annual}} \approx 250\cdot \mu_{\mathrm{day}}\)（小漂移近似）

> **不要混用“年化 dt”与“日化参数”。** 若采用本规范，统一在**日尺度**上做 dt 折算。

---

## 4. 涨跌停规则（强约束）

- 以**昨收** \(C_{y}\) 为基准，设限制比例 `limit`（如 10%）：
  - 上沿 \(U = C_{y}\cdot (1 + \mathrm{limit})\)  
  - 下沿 \(L = C_{y}\cdot (1 - \mathrm{limit})\)
- 每步先算 \(P_{t+\Delta}^{\mathrm{raw}}\)，再钳制：
  - \(P_{t+\Delta} = \min(\max(P_{t+\Delta}^{\mathrm{raw}}, L), U)\)
- 日切换时重置 \(C_{y}\)（新的昨收）。

> 可选：若连续命中上/下沿 ≥ K 步，进入“封板”状态，直至收盘仅允许沿带内微动（仿真更像 A 股）。

---

## 5. OHLC 生成（更真实的极值）

仅用“收盘±对称扰动”会产生不合理形态。采用**布朗桥近似**：

1. 已得单步总对数收益 \(R\)（从开到收）。  
2. 采样两个中间增量 \(u,v \sim \mathcal{N}(0, \sigma_\ast^2)\)（\(\sigma_\ast^2\) 为该步合成方差的比例），构造路径点：
   - \(x_0=0,\; x_1=u,\; x_2=u+v,\; x_3=R\)
3. 价格路径：\(p_j = P_\mathrm{open}\cdot e^{x_j}\)；对每个 \(p_j\) 应用**涨跌停钳制**；  
4. 当步 High/Low 分别取路径内最大/最小。

> 该方法计算量低、形态自然；需要严格在**钳制后**再取极值。

---

## 6. 波动聚集（可选但推荐）

对 idiosyncratic（个股）项使用 **EWMA** 或 **GARCH(1,1)**：

- EWMA：\(\sigma_{i,t}^2 = \lambda \sigma_{i,t-1}^2 + (1-\lambda)\epsilon_{i,t-1}^2\)  
- GARCH(1,1)：\(\sigma_{i,t}^2 = \omega + \alpha \epsilon_{i,t-1}^2 + \beta \sigma_{i,t-1}^2\)

其中 \(\epsilon_{i,t-1}\) 为上一步个股**残差对数收益**。

---

## 7. 日内 U 形波动（可选）

设时变系数 \(m(t)\)（开盘/收盘放大，午间缩小），对所有 \(\sigma\) 乘以 \(m(t)\)。示例：

| 时段            | \(m(t)\) |
|-----------------|----------|
| 开盘前 30 分钟  | 1.3      |
| 正常时段        | 1.0      |
| 午间低波        | 0.85     |
| 收盘前 30 分钟  | 1.3      |

---

## 8. 参数与默认值（建议起点）

- 因子权重：`w_m=0.5, w_s=0.3, w_i=0.2`  
- 相关系数：`\rho_{ms}=0.75`  
- 年化波动（示例）：`\sigma_m=18%`, `\sigma_s=25%`, `\sigma_i=45%`  
- 市场日均漂移：`\mu_m` 依据场景（牛/熊/横）设为 \([−0.03\%, +0.05\%]\) / 日  
- β 分布：  
  - 指数 β：个股 \( \beta_m^{(k)} \sim \mathcal{N}(1.0, 0.2^2) \) 截断于 \([0.4, 1.8]\)  
  - 板块 β：同理但以板块为中心，个股在板块周围轻微扰动  
- 涨跌停：`limit = 0.10`（或科创/创业板相应值）

> 实盘风格调整：用 **目标统计量**（日波动、行业内相关、指数 β）做约束，反解 \(\sigma\)、\(w\)、\(\rho\)。

---

## 9. 伪代码示意（按日体系）

```python
# === 常量与换算 ===
steps_per_day = 4800            # 3秒/步示例；若用1分钟步长则为240
dt = 1.0 / steps_per_day
limit = 0.10                    # ±10% 涨跌停
rho_ms = 0.75
w_m, w_s, w_i = 0.5, 0.3, 0.2

# 年->日换算（示例值）
sigma_m_day = sigma_m_annual / np.sqrt(250)
sigma_s_day = sigma_s_annual / np.sqrt(250)
sigma_i_day = sigma_i_annual / np.sqrt(250)

# 可选：时变U形
def vol_mult(t_idx): ...
# 可选：GARCH/EWMA
def update_sigma_i(prev_sigma_i, prev_epsilon): ...

for day in trading_days:
    C_y = previous_close  # 昨收
    upper, lower = C_y * (1+limit), C_y * (1-limit)

    for step in range(steps_per_day):
        # 相关增量
        z0, z1, z2 = np.random.normal(size=3)
        z_m = z0
        z_s = rho_ms * z0 + np.sqrt(1 - rho_ms**2) * z1
        z_i = z2

        # 时变波动因子
        m = vol_mult(step)

        # 因子对数收益
        r_m = mu_m_daily * dt + (sigma_m_day * m) * np.sqrt(dt) * z_m
        r_s = (sigma_s_day * m) * np.sqrt(dt) * z_s
        r_i = (sigma_i_day * m) * np.sqrt(dt) * z_i  # 可替换为时变sigma_i_t

        # 个股收益
        r = w_m * beta_m_k * r_m + w_s * beta_s_k * r_s + w_i * r_i

        # 价格更新（raw）
        p_raw = price * np.exp(r)

        # 涨跌停钳制
        price = min(max(p_raw, lower), upper)

        # 采样中间轨迹（近似布朗桥）以生成High/Low
        # 仅在聚合到更大bar时需要
        # ...

    previous_close = price  # 日终收盘
```

---

## 10. 校准流程（最小可行）

1. **波动对齐**：模拟 N 天，计算指数/板块/个股的日化波动，与目标 \((\sigma_m,\sigma_s,\sigma_i)\) 比较，按比例调整。  
2. **相关/β 对齐**：计算个股对指数的 β、同板块个股间相关；调 \(\rho_{ms}\)、\(w\)、β 分布方差使其落入目标区间。  
3. **带宽校验**：检查任何日内路径均未越过 \([L,U]\)。

可用简单的**网格+局部线性回归**搜参，避免昂贵优化器。

---

## 11. 监控指标（线上自检）

- 单步与单日收益分布：均值≈预期、峰度>3（若启用聚集/混合）。  
- 日内累积方差与目标的偏差 < 10%。  
- 板块内平均相关系数与目标区间的偏差 < 0.05。  
- β 分布均值/标准差接近设定。  
- 涨跌停命中率、封板持续步数分布合理。  
- OHLC 形态约束（High ≥ max(Open,Close)，Low ≤ min(Open,Close)）100% 满足。

---

## 12. 配置接口（建议）

- 全局：`steps_per_day, limit, rho_ms, w_m/w_s/w_i, seed`  
- 市场：`\mu_m_daily, \sigma_m_annual`  
- 板块：`\sigma_s_annual, \beta_s` 生成器（均值、方差、截断）  
- 个股：`\sigma_i_annual, \beta_m` 生成器（均值、方差、截断）  
- 可选模块：`u_shape: on/off & schedule`，`vol_clustering: {type, params}`，`events: list`

---

## 13. 可重复性与随机性

- 设置 `seed` 并将**所有随机源**（含相关增量与事件触发）挂到同一 RNG。  
- 在分布式/并行时段，使用**可复现流**（如 Philox/Threefry）和**确定性切分**。

---

## 14. 性能注意

- 预生成相关增量（向量化）；  
- 分层缓存参数（市场/板块/个股）以减少索引开销；  
- 聚合到分钟/5分钟时，用“布朗桥近似”代替逐tick展开以提速；  
- I/O 分离：计算与落盘异步队列处理。

---

## 15. 与旧方案的关键差异（变更清单）

- **统一时间尺度为日**，避免“日漂移×年化 dt”的误配。  
- **涨跌停按昨收价带钳制**，杜绝多步叠加越带。  
- **相关性由共享随机冲击塑造**，去除叠漂移的伪相关。  
- **板块噪声改为 σ×√dt**，步长变化不再失衡。  
- **OHLC 改为布朗桥近似**，极值更符合路径。  
- 增加**波动聚集、U形波动、封板**等可选模块与校验指标。

---

## 16. 快速验收（一页清单）

- [ ] 日内累积方差 ≈ 目标日化方差（误差 < 10%）  
- [ ] 任何时点价格均在 \([L,U]\) 内  
- [ ] β 与相关结构落入预期区间  
- [ ] OHLC 形态约束 100% 满足  
- [ ] 种子复现实验一致  
- [ ] 压力测试（极端 μ/σ/事件）不崩

---

**说明**：本规范默认“日为基准”的实现。若需“年为基准”，请将所有 μ/σ 转为年化，并以 `dt_year = Δt / (240×250分钟)` 一致处理；两种体系不能混用。