# Aè‚¡é£æ ¼è™šæ‹Ÿå¸‚åœºè®¾è®¡æ–¹æ¡ˆ

## ä¸€ã€æ¿å—ä½“ç³»è®¾è®¡

### 1.1 ä¸»æ¿å—åˆ†ç±»ï¼ˆå‚è€ƒç”³ä¸‡ä¸€çº§è¡Œä¸šï¼‰

| æ¿å—ä»£ç  | æ¿å—åç§° | è‚¡ç¥¨æ•°é‡ | ç‰¹å¾ | å¹³å‡æ³¢åŠ¨ç‡ |
|---------|---------|---------|------|-----------|
| **Technology** | ç§‘æŠ€æ¿å— | 15-20åª | é«˜æˆé•¿ã€é«˜æ³¢åŠ¨ | 3.5% |
| **Finance** | é‡‘èæ¿å— | 10-12åª | ä½æ³¢åŠ¨ã€è“ç­¹ | 1.8% |
| **Consumer** | æ¶ˆè´¹æ¿å— | 12-15åª | ç¨³å¥æˆé•¿ | 2.5% |
| **Industry** | å·¥ä¸šæ¿å— | 10-12åª | å‘¨æœŸæ€§ | 2.8% |
| **Healthcare** | åŒ»è¯æ¿å— | 10-12åª | é˜²å¾¡æ€§ | 2.2% |
| **RealEstate** | åœ°äº§æ¿å— | 8-10åª | æ”¿ç­–æ•æ„Ÿ | 3.0% |
| **Energy** | èƒ½æºæ¿å— | 8-10åª | å‘¨æœŸæ€§å¼º | 3.2% |
| **Materials** | ææ–™æ¿å— | 6-8åª | å‘¨æœŸæ€§ | 2.9% |
| **Utilities** | å…¬ç”¨äº‹ä¸š | 5-6åª | ä½æ³¢åŠ¨ | 1.5% |
| **Telecom** | é€šä¿¡æ¿å— | 4-5åª | ç¨³å®š | 2.0% |

**åˆè®¡**ï¼šçº¦80-100åªè™šæ‹Ÿè‚¡ç¥¨

### 1.2 å¸‚å€¼åˆ†ç±»ï¼ˆå‚è€ƒAè‚¡å¸‚å€¼åˆ†å¸ƒï¼‰

| ç±»åˆ« | å¸‚å€¼èŒƒå›´ | å æ¯” | ç‰¹å¾ | ä»£ç å‰ç¼€ |
|-----|---------|-----|------|---------|
| **è¶…å¤§ç›˜è‚¡** | >5000äº¿ | 10% | è“ç­¹ã€æƒé‡è‚¡ | HS (æ²ªæ·±) |
| **å¤§ç›˜è‚¡** | 1000-5000äº¿ | 20% | ç¨³å¥ | HS |
| **ä¸­ç›˜è‚¡** | 300-1000äº¿ | 35% | æˆé•¿ | SZ (æ·±åœ³) |
| **å°ç›˜è‚¡** | 100-300äº¿ | 25% | é«˜æˆé•¿ | SZ |
| **å¾®ç›˜è‚¡** | <100äº¿ | 10% | é«˜é£é™© | CY (åˆ›ä¸šæ¿) |

---

## äºŒã€è™šæ‹ŸæŒ‡æ•°ä½“ç³»è®¾è®¡

### 2.1 æ ¸å¿ƒæŒ‡æ•°

#### **å¿«ä¹ç»¼åˆæŒ‡æ•°ï¼ˆHAPPY300ï¼‰**
- **å®šä½**ï¼šå¯¹æ ‡æ²ªæ·±300
- **æ ·æœ¬è‚¡**ï¼šå¸‚å€¼æœ€å¤§çš„300åªè™šæ‹Ÿè‚¡ç¥¨
- **åŠ æƒæ–¹å¼**ï¼šè‡ªç”±æµé€šå¸‚å€¼åŠ æƒ
- **åŸºç‚¹**ï¼š3000ç‚¹ï¼ˆåˆå§‹å€¼ï¼‰
- **ä»£ç **ï¼šHAPPY300 æˆ– HS300

#### **å¿«ä¹50æŒ‡æ•°ï¼ˆHAPPY50ï¼‰**
- **å®šä½**ï¼šå¯¹æ ‡ä¸Šè¯50
- **æ ·æœ¬è‚¡**ï¼šè¶…å¤§ç›˜è“ç­¹è‚¡50åª
- **ç‰¹å¾**ï¼šä½æ³¢åŠ¨ã€é«˜åˆ†çº¢
- **åŸºç‚¹**ï¼š2500ç‚¹

#### **åˆ›æ–°æˆé•¿æŒ‡æ•°ï¼ˆGROW100ï¼‰**
- **å®šä½**ï¼šå¯¹æ ‡åˆ›ä¸šæ¿æŒ‡
- **æ ·æœ¬è‚¡**ï¼šç§‘æŠ€ã€æ–°èƒ½æºç­‰æˆé•¿è‚¡100åª
- **ç‰¹å¾**ï¼šé«˜æˆé•¿ã€é«˜æ³¢åŠ¨
- **åŸºç‚¹**ï¼š2000ç‚¹

### 2.2 è¡Œä¸šæŒ‡æ•°

| æŒ‡æ•°åç§° | ä»£ç  | æ ·æœ¬è‚¡ | ç”¨é€” |
|---------|------|--------|------|
| ç§‘æŠ€æŒ‡æ•° | TECH | ç§‘æŠ€æ¿å—å…¨éƒ¨ | æ¿å—è½®åŠ¨ |
| é‡‘èæŒ‡æ•° | FIN | é‡‘èæ¿å—å…¨éƒ¨ | ç»æµæ™´é›¨è¡¨ |
| æ¶ˆè´¹æŒ‡æ•° | CONS | æ¶ˆè´¹æ¿å—å…¨éƒ¨ | å†…éœ€æŒ‡æ ‡ |
| æ–°èƒ½æºæŒ‡æ•° | NEV | æ–°èƒ½æºç›¸å…³ | ä¸»é¢˜æŠ•èµ„ |

---

## ä¸‰ã€è‚¡ç¥¨å‘½åè§„åˆ™ï¼ˆAè‚¡é£æ ¼ï¼‰

### 3.1 å‘½åä½“ç³»

**æ ¼å¼**ï¼š`ä»£ç (6ä½) + åç§°`

**ä»£ç è§„åˆ™**ï¼ˆå‚è€ƒçœŸå®Aè‚¡ï¼‰ï¼š
- `600xxx`ï¼šæ²ªå¸‚ä¸»æ¿ï¼ˆå¤§ç›˜è“ç­¹ï¼‰
- `601xxx`ï¼šæ²ªå¸‚ä¸»æ¿ï¼ˆå¤§å‹å›½ä¼ï¼‰
- `603xxx`ï¼šæ²ªå¸‚ä¸»æ¿ï¼ˆæ°‘è¥ä¼ä¸šï¼‰
- `000xxx`ï¼šæ·±å¸‚ä¸»æ¿
- `002xxx`ï¼šæ·±å¸‚ä¸­å°æ¿
- `300xxx`ï¼šåˆ›ä¸šæ¿

**ç¤ºä¾‹**ï¼š
```
600001  å¿«ä¹é“¶è¡Œ        ï¼ˆå¯¹æ ‡ï¼š601398 å·¥å•†é“¶è¡Œï¼‰
600028  å›½å®¶ç”µç½‘        ï¼ˆå¯¹æ ‡ï¼š600900 é•¿æ±Ÿç”µåŠ›ï¼‰
600519  è´µå·å¿«ä¹        ï¼ˆå¯¹æ ‡ï¼š600519 è´µå·èŒ…å°ï¼‰
601888  ä¸­å›½äº‘è®¡ç®—      ï¼ˆå¯¹æ ‡ï¼š601888 ä¸­å›½ä¸­å…ï¼‰
000001  æ·±åœ³ç§‘æŠ€        ï¼ˆå¯¹æ ‡ï¼š000001 å¹³å®‰é“¶è¡Œï¼‰
002415  èŠ¯ç‰‡åˆ¶é€         ï¼ˆå¯¹æ ‡ï¼š002415 æµ·åº·å¨è§†ï¼‰
300059  æ–°èƒ½æºæ±½è½¦      ï¼ˆå¯¹æ ‡ï¼š300059 ä¸œæ–¹è´¢å¯Œï¼‰
```

### 3.2 å®Œæ•´è‚¡ç¥¨æ¸…å•ï¼ˆ80åªç¤ºä¾‹ï¼‰

#### é‡‘èæ¿å—ï¼ˆ12åªï¼‰
```
ä»£ç       åç§°             å¸‚å€¼(äº¿)  ä»·æ ¼   æ³¢åŠ¨ç‡
600001   å¿«ä¹é“¶è¡Œ          8000     15.00   1.5%   (æƒé‡è‚¡)
601398   å›½æ°‘é“¶è¡Œ          12000    6.50    1.4%   (è¶…çº§æƒé‡)
601328   äº¤é€šé“¶è¡Œ          4500     8.20    1.6%
601166   åŸå¸‚é“¶è¡Œ          3200     9.80    1.7%
600036   æ‹›å•†é“¶è¡Œ          9000     42.00   1.8%
601318   å¹³å®‰ä¿é™©          15000    58.00   2.0%
600030   ä¸­ä¿¡è¯åˆ¸          3800     25.00   2.5%
601688   åæ³°è¯åˆ¸          2500     18.50   2.6%
601066   ä¸­ä¿¡å»ºè®¾          2100     12.30   2.3%
600999   æ‹›å•†è¯åˆ¸          1800     16.80   2.7%
601998   ä¸­ä¿¡é“¶è¡Œ          3500     5.60    1.6%
600016   æ°‘ç”Ÿé“¶è¡Œ          4200     4.80    1.9%
```

#### ç§‘æŠ€æ¿å—ï¼ˆ20åªï¼‰
```
ä»£ç       åç§°             å¸‚å€¼(äº¿)  ä»·æ ¼   æ³¢åŠ¨ç‡
600519   äº‘ç«¯è®¡ç®—          5000     180.00  3.0%   (ç§‘æŠ€é¾™å¤´)
688001   åŠå¯¼ä½“èŠ¯ç‰‡        3500     120.00  4.2%
688012   äººå·¥æ™ºèƒ½          2800     95.00   4.5%
300059   äº’è”ç½‘ç§‘æŠ€        4200     68.00   3.8%
300750   æ™ºèƒ½ç¡¬ä»¶          1500     52.00   4.0%
002415   è§†é¢‘ç›‘æ§          3000     48.00   3.5%
002230   é€šä¿¡è®¾å¤‡          1800     38.00   3.6%
300033   äº‘å­˜å‚¨            1200     45.00   4.2%
603986   è½¯ä»¶å¼€å‘          980      32.00   3.9%
688111   é‡å­è®¡ç®—          650      88.00   5.5%   (æ¦‚å¿µè‚¡)
688188   å…‰åˆ»æœº            520      220.00  6.0%   (é«˜ç§‘æŠ€)
300456   å¤§æ•°æ®            1100     28.00   4.1%
002049   ç´«å…‰èŠ¯ç‰‡          2200     42.00   4.3%
603160   ç”µå­å…ƒä»¶          880      25.00   3.7%
300661   5Gé€šä¿¡            1350     38.00   4.0%
002371   åŒ—æ–¹ååˆ›          1800     78.00   4.8%
688008   é›†æˆç”µè·¯          980      56.00   5.2%
300142   ç‰©è”ç½‘            720      18.50   4.4%
688036   å·¥ä¸šè½¯ä»¶          560      42.00   4.6%
300308   ç½‘ç»œå®‰å…¨          890      28.00   4.2%
```

#### æ¶ˆè´¹æ¿å—ï¼ˆ15åªï¼‰
```
ä»£ç       åç§°             å¸‚å€¼(äº¿)  ä»·æ ¼   æ³¢åŠ¨ç‡
600519   è´µå·å¿«ä¹          22000    1680.00 2.0%   (èŒ…å°å¯¹æ ‡)
000858   äº”ç²®æ¶²            5800     168.00  2.2%
600887   ä¼Šåˆ©ä¹³ä¸š          3200     38.00   2.3%
000333   ç¾çš„ç”µå™¨          5500     72.00   2.5%
000651   æ ¼åŠ›ç”µå™¨          3800     35.00   2.6%
603288   æµ·å¤©è°ƒå‘³          4200     88.00   2.4%
002304   æ´‹æ²³é…’ä¸š          1800     128.00  2.8%
600779   å…¨èšå¾·            420      12.00   3.2%
002507   è¿é”è¶…å¸‚          680      18.50   2.9%
600600   é’å²›å•¤é…’          980      78.00   2.5%
603369   ä»Šä¸–ç¼˜            520      48.00   2.7%
002572   å®¶å±…å®¶ç”µ          1200     52.00   3.0%
600809   å¿«ä¹æœé¥°          850      22.00   3.3%
603589   é£Ÿå“é¥®æ–™          680      35.00   2.8%
300999   å¿«ä¹é¤é¥®          420      28.00   3.5%
```

#### æ–°èƒ½æºæ¿å—ï¼ˆ12åªï¼‰
```
ä»£ç       åç§°             å¸‚å€¼(äº¿)  ä»·æ ¼   æ³¢åŠ¨ç‡
300750   æ–°èƒ½æºæ±½è½¦        8000     245.00  4.5%   (é¾™å¤´)
002594   åŠ¨åŠ›ç”µæ±           4500     180.00  4.8%
601012   å…‰ä¼ç§‘æŠ€          3200     85.00   4.2%
600438   é£åŠ›å‘ç”µ          1800     28.00   3.8%
300274   å‚¨èƒ½æŠ€æœ¯          2100     95.00   5.0%
688599   é”‚ç”µææ–™          1500     120.00  5.2%
002129   å……ç”µæ¡©            980      42.00   4.6%
300014   æ°¢èƒ½æº            720      35.00   5.5%
601865   å¤ªé˜³èƒ½            1200     18.50   4.0%
300763   ç”µæ± å›æ”¶          560      28.00   4.9%
688303   é’ ç”µæ±             380      68.00   6.0%
603501   æ–°èƒ½æºè½¦ä¼        2500     158.00  4.7%
```

#### å·¥ä¸šæ¿å—ï¼ˆ10åªï¼‰
```
ä»£ç       åç§°             å¸‚å€¼(äº¿)  ä»·æ ¼   æ³¢åŠ¨ç‡
601668   ä¸­å›½å»ºç­‘          4500     6.80    2.5%
600585   æœºæ¢°åˆ¶é€           2200     28.00   3.0%
601766   èˆªç©ºèˆªå¤©          1800     35.00   3.2%
600031   é‡å·¥é›†å›¢          3200     12.50   2.8%
600150   èˆ¹èˆ¶åˆ¶é€           1500     18.00   3.4%
002202   å·¥ç¨‹æœºæ¢°          980      22.00   3.1%
601919   é«˜é“è£…å¤‡          2800     8.50    2.6%
603766   ç”µæ°”è®¾å¤‡          720      42.00   3.3%
600875   åŒ–å·¥ææ–™          1200     25.00   3.5%
002459   é€šç”¨æœºæ¢°          680      15.50   3.2%
```

#### åŒ»è¯æ¿å—ï¼ˆ11åªï¼‰
```
ä»£ç       åç§°             å¸‚å€¼(äº¿)  ä»·æ ¼   æ³¢åŠ¨ç‡
600276   ç”Ÿç‰©åŒ»è¯          3800     88.00   2.5%
000661   é•¿æ˜¥åˆ¶è¯          2200     45.00   2.8%
002007   åä¸œåŒ»è¯          1500     32.00   2.6%
300015   åˆ›æ–°è¯            2800     68.00   3.2%
603259   åŒ»ç–—å™¨æ¢°          1200     58.00   2.9%
688180   åŸºå› æµ‹åº          680      95.00   4.0%
300529   ä¸­è¯åˆ¶é€           980      28.00   2.7%
600521   ç–«è‹—ç ”å‘          1800     78.00   3.5%
002773   åŒ»ç–—æœåŠ¡          720      42.00   3.0%
688396   ç»†èƒæ²»ç–—          450      120.00  4.8%
603392   ä¿å¥å“            580      25.00   2.8%
```

---

## å››ã€æŒ‡æ•°è®¡ç®—æ–¹æ³•

### 4.1 HAPPY300æŒ‡æ•°è®¡ç®—å…¬å¼

#### å¸‚å€¼åŠ æƒæ³•ï¼ˆå‚è€ƒæ²ªæ·±300ï¼‰

```python
# æŒ‡æ•°è®¡ç®—å…¬å¼
æŒ‡æ•° = (å½“å‰æ€»å¸‚å€¼ / åŸºæœŸæ€»å¸‚å€¼) Ã— åŸºç‚¹

# è¯¦ç»†å…¬å¼
HAPPY300 = Î£(è‚¡ä»·i Ã— æµé€šè‚¡æœ¬i Ã— æƒé‡å› å­i) / é™¤æ•° Ã— 1000
```

#### æƒé‡å› å­è®¡ç®—

```python
# å•åªè‚¡ç¥¨æƒé‡ä¸Šé™ï¼š10%ï¼ˆé˜²æ­¢è¿‡åº¦é›†ä¸­ï¼‰
æƒé‡å› å­ = min(è‡ªç”±æµé€šå¸‚å€¼ / æ€»è‡ªç”±æµé€šå¸‚å€¼, 0.10)

# ç¤ºä¾‹ï¼š
# 601318 å¹³å®‰ä¿é™©ï¼šå¸‚å€¼15000äº¿ï¼Œå æ¯”12% â†’ é™åˆ¶åˆ°10%
# 600519 è´µå·å¿«ä¹ï¼šå¸‚å€¼22000äº¿ï¼Œå æ¯”15% â†’ é™åˆ¶åˆ°10%
# å…¶ä»–è‚¡ç¥¨ï¼šæŒ‰å®é™…å¸‚å€¼æ¯”ä¾‹
```

### 4.2 æŒ‡æ•°æˆåˆ†è‚¡æƒé‡åˆ†å¸ƒï¼ˆHAPPY300ç¤ºä¾‹ï¼‰

| æ¡£ä½ | å•è‚¡æƒé‡ | è‚¡ç¥¨æ•° | åˆè®¡æƒé‡ | ä»£è¡¨è‚¡ç¥¨ |
|------|---------|--------|---------|---------|
| è¶…å¤§æƒé‡ | 5-10% | 5åª | 40% | å¹³å®‰ã€èŒ…å°ã€å·¥è¡Œã€æ–°èƒ½æºæ±½è½¦ |
| å¤§æƒé‡ | 2-5% | 15åª | 45% | æ‹›å•†é“¶è¡Œã€ç¾çš„ã€äº”ç²®æ¶² |
| ä¸­æƒé‡ | 0.5-2% | 80åª | 15% | å„è¡Œä¸šé¾™å¤´ |
| å°æƒé‡ | <0.5% | 200åª | - | ä¸çº³å…¥HAPPY300 |

### 4.3 æŒ‡æ•°è®¡ç®—å®ç°

```python
# backend/lib/index_calculator.py

class IndexCalculator:
    """è™šæ‹ŸæŒ‡æ•°è®¡ç®—å™¨"""

    def __init__(self, db_manager):
        self.db = db_manager
        # åŸºæœŸè®¾ç½®ï¼š2024-01-01 çš„å¸‚å€¼ä½œä¸ºåŸºæœŸ
        self.base_date = datetime(2024, 1, 1)
        self.base_point = 3000  # HAPPY300 åŸºç‚¹

    def calculate_happy300(self, timestamp: int) -> float:
        """
        è®¡ç®— HAPPY300 æŒ‡æ•°

        Args:
            timestamp: å½“å‰æ—¶é—´æˆ³

        Returns:
            æŒ‡æ•°ç‚¹ä½
        """
        # 1. è·å–æˆåˆ†è‚¡åˆ—è¡¨ï¼ˆå¸‚å€¼å‰300ï¼‰
        constituents = self.get_top_stocks_by_market_cap(limit=300)

        # 2. è·å–æˆåˆ†è‚¡å½“å‰ä»·æ ¼
        current_market_cap = 0
        for stock in constituents:
            price = self.get_stock_price(stock.symbol, timestamp)
            shares = stock.outstanding_shares  # æµé€šè‚¡æœ¬
            market_cap = price * shares

            # åº”ç”¨æƒé‡ä¸Šé™
            weight = min(market_cap / total_market_cap, 0.10)
            current_market_cap += market_cap * weight

        # 3. è·å–åŸºæœŸå¸‚å€¼
        base_market_cap = self.get_base_market_cap(constituents)

        # 4. è®¡ç®—æŒ‡æ•°
        index_value = (current_market_cap / base_market_cap) * self.base_point

        return round(index_value, 2)

    def calculate_index_change(self, current: float, previous: float) -> dict:
        """è®¡ç®—æŒ‡æ•°æ¶¨è·Œ"""
        change = current - previous
        change_pct = (change / previous) * 100

        return {
            'current': current,
            'change': round(change, 2),
            'change_pct': round(change_pct, 2)
        }
```

---

## äº”ã€å¸‚åœºè”åŠ¨æœºåˆ¶

### 5.1 æŒ‡æ•°ä¸ä¸ªè‚¡è”åŠ¨

```python
# ä¸ªè‚¡ä»·æ ¼ç”Ÿæˆæ—¶è€ƒè™‘å¤§ç›˜å½±å“

def generate_stock_price_with_market(stock, market_trend):
    """
    ç”Ÿæˆè‚¡ç¥¨ä»·æ ¼ï¼ˆè€ƒè™‘å¤§ç›˜å½±å“ï¼‰

    Args:
        stock: è‚¡ç¥¨å¯¹è±¡
        market_trend: å¤§ç›˜è¶‹åŠ¿ï¼ˆ-0.03 åˆ° +0.03ï¼‰

    Returns:
        æ–°ä»·æ ¼
    """
    # 1. ä¸ªè‚¡è‡ªèº«çš„GBMç”Ÿæˆï¼ˆ70%æƒé‡ï¼‰
    individual_change = gbm_generate(stock)

    # 2. å¤§ç›˜å½±å“ï¼ˆ30%æƒé‡ï¼‰
    market_influence = market_trend * stock.beta * 0.3

    # 3. è¡Œä¸šå½±å“ï¼ˆå¯é€‰ï¼Œæš‚ä¸å®ç°ï¼‰
    # sector_influence = get_sector_trend(stock.sector) * 0.1

    # 4. ç»¼åˆè®¡ç®—
    total_change = individual_change * 0.7 + market_influence

    new_price = stock.current_price * (1 + total_change)

    return new_price
```

### 5.2 Betaç³»æ•°è®¾ç½®

| è‚¡ç¥¨ç±»å‹ | Betaå€¼ | å«ä¹‰ | ç¤ºä¾‹ |
|---------|--------|------|------|
| è¶…çº§è“ç­¹ | 0.6-0.8 | æŠ—è·Œã€è·Ÿéšæ€§å¼± | é“¶è¡Œã€å…¬ç”¨äº‹ä¸š |
| æ™®é€šè“ç­¹ | 0.8-1.0 | è·Ÿéšå¤§ç›˜ | æ¶ˆè´¹ã€åŒ»è¯ |
| æˆé•¿è‚¡ | 1.0-1.3 | å¤§ç›˜æ¶¨å®ƒæ¶¨æ›´å¤š | ç§‘æŠ€ã€æ–°èƒ½æº |
| å°ç›˜è‚¡ | 1.3-1.8 | é«˜å¼¹æ€§ | åˆ›ä¸šæ¿ã€æ¦‚å¿µè‚¡ |

```sql
-- åœ¨ stock_metadata è¡¨æ·»åŠ  beta å­—æ®µ
ALTER TABLE stock_metadata ADD COLUMN beta NUMERIC(4, 2) DEFAULT 1.0;

-- æ›´æ–°ç¤ºä¾‹
UPDATE stock_metadata SET beta = 0.7 WHERE sector = 'Finance';
UPDATE stock_metadata SET beta = 1.2 WHERE sector = 'Technology';
UPDATE stock_metadata SET beta = 1.5 WHERE symbol LIKE '300%';
```

### 5.3 å¸‚åœºçŠ¶æ€åŒæ­¥

```python
# å…¨å¸‚åœºç»Ÿä¸€çš„å¸‚åœºçŠ¶æ€ï¼ˆç‰›å¸‚/ç†Šå¸‚/æ¨ªç›˜ï¼‰

class MarketStateManager:
    """å…¨å¸‚åœºçŠ¶æ€ç®¡ç†å™¨"""

    def __init__(self):
        self.global_state = MarketState.SIDEWAYS
        self.state_duration = 0

    def update_global_state(self):
        """æ›´æ–°å…¨å±€å¸‚åœºçŠ¶æ€"""
        # æ¯ä¸ªäº¤æ˜“æ—¥å¼€ç›˜æ—¶ï¼Œ10%æ¦‚ç‡åˆ‡æ¢å¸‚åœºçŠ¶æ€
        if random() < 0.10:
            self.global_state = self.transition_state(self.global_state)
            logger.info(f"å¸‚åœºçŠ¶æ€åˆ‡æ¢ä¸º: {self.global_state.value}")

    def get_market_trend(self) -> float:
        """è·å–å½“å‰å¸‚åœºè¶‹åŠ¿å¼ºåº¦"""
        trends = {
            MarketState.BULL: +0.02,    # ç‰›å¸‚ï¼šæ—¥å‡æ¶¨0.2%
            MarketState.BEAR: -0.02,    # ç†Šå¸‚ï¼šæ—¥å‡è·Œ0.2%
            MarketState.SIDEWAYS: 0.0,  # æ¨ªç›˜ï¼šæ— è¶‹åŠ¿
        }
        return trends[self.global_state]
```

---

## å…­ã€æ•°æ®åº“è¡¨ç»“æ„æ‰©å±•

### 6.1 æ–°å¢è¡¨ï¼šå¸‚åœºæŒ‡æ•°

```sql
-- å¸‚åœºæŒ‡æ•°è¡¨
CREATE TABLE market_indices (
    id SERIAL PRIMARY KEY,
    index_code VARCHAR(20) NOT NULL,     -- HAPPY300, HAPPY50
    index_name VARCHAR(50) NOT NULL,     -- å¿«ä¹ç»¼åˆæŒ‡æ•°
    time BIGINT NOT NULL,                 -- æ—¶é—´æˆ³
    value NUMERIC(10, 2) NOT NULL,       -- æŒ‡æ•°ç‚¹ä½
    change_value NUMERIC(10, 2),         -- æ¶¨è·Œç‚¹æ•°
    change_pct NUMERIC(6, 3),            -- æ¶¨è·Œå¹…
    volume BIGINT,                        -- æˆäº¤é‡ï¼ˆäº¿è‚¡ï¼‰
    amount BIGINT,                        -- æˆäº¤é¢ï¼ˆäº¿å…ƒï¼‰
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    UNIQUE(index_code, time)
);

-- ç´¢å¼•
CREATE INDEX idx_indices_code_time ON market_indices (index_code, time DESC);

-- åˆå§‹åŒ–æŒ‡æ•°
INSERT INTO market_indices (index_code, index_name, time, value, change_value, change_pct)
VALUES
    ('HAPPY300', 'å¿«ä¹ç»¼åˆæŒ‡æ•°', extract(epoch from now())::bigint, 3000.00, 0, 0),
    ('HAPPY50', 'å¿«ä¹50æŒ‡æ•°', extract(epoch from now())::bigint, 2500.00, 0, 0),
    ('GROW100', 'åˆ›æ–°æˆé•¿æŒ‡æ•°', extract(epoch from now())::bigint, 2000.00, 0, 0);
```

### 6.2 æ‰©å±•è¡¨ï¼šè‚¡ç¥¨å…ƒæ•°æ®

```sql
-- æ‰©å±• stock_metadata è¡¨
ALTER TABLE stock_metadata
ADD COLUMN IF NOT EXISTS outstanding_shares BIGINT DEFAULT 1000000000,  -- æµé€šè‚¡æœ¬ï¼ˆ10äº¿è‚¡ï¼‰
ADD COLUMN IF NOT EXISTS market_cap BIGINT,                             -- æ€»å¸‚å€¼ï¼ˆäº¿å…ƒï¼‰
ADD COLUMN IF NOT EXISTS beta NUMERIC(4, 2) DEFAULT 1.0,               -- Betaç³»æ•°
ADD COLUMN IF NOT EXISTS weight_in_index NUMERIC(6, 4),                -- åœ¨æŒ‡æ•°ä¸­çš„æƒé‡
ADD COLUMN IF NOT EXISTS is_index_constituent BOOLEAN DEFAULT FALSE,   -- æ˜¯å¦æ˜¯æˆåˆ†è‚¡
ADD COLUMN IF NOT EXISTS listing_date DATE,                            -- ä¸Šå¸‚æ—¥æœŸ
ADD COLUMN IF NOT EXISTS stock_type VARCHAR(20) DEFAULT 'Aè‚¡';         -- è‚¡ç¥¨ç±»å‹

-- æ·»åŠ æ³¨é‡Š
COMMENT ON COLUMN stock_metadata.outstanding_shares IS 'æµé€šè‚¡æœ¬ï¼ˆè‚¡ï¼‰';
COMMENT ON COLUMN stock_metadata.market_cap IS 'æ€»å¸‚å€¼ï¼ˆäº¿å…ƒï¼‰';
COMMENT ON COLUMN stock_metadata.beta IS 'Betaç³»æ•°ï¼Œè¡¡é‡ä¸å¤§ç›˜ç›¸å…³æ€§';
COMMENT ON COLUMN stock_metadata.weight_in_index IS 'åœ¨HAPPY300ä¸­çš„æƒé‡';
```

### 6.3 æ–°å¢è¡¨ï¼šæŒ‡æ•°æˆåˆ†è‚¡

```sql
-- æŒ‡æ•°æˆåˆ†è‚¡å…³ç³»è¡¨
CREATE TABLE index_constituents (
    id SERIAL PRIMARY KEY,
    index_code VARCHAR(20) NOT NULL,      -- HAPPY300
    stock_symbol VARCHAR(20) NOT NULL,    -- 600001
    weight NUMERIC(6, 4) NOT NULL,        -- æƒé‡ 0.0850 è¡¨ç¤º8.5%
    rank INTEGER,                          -- åœ¨æŒ‡æ•°ä¸­çš„æ’å
    join_date DATE,                        -- çº³å…¥æ—¥æœŸ
    is_active BOOLEAN DEFAULT TRUE,       -- æ˜¯å¦ä»åœ¨æŒ‡æ•°ä¸­
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    UNIQUE(index_code, stock_symbol)
);

-- ç´¢å¼•
CREATE INDEX idx_constituents_index ON index_constituents (index_code);
CREATE INDEX idx_constituents_stock ON index_constituents (stock_symbol);
```

---

## ä¸ƒã€å®æ–½æ­¥éª¤

### Phase 1: è‚¡ç¥¨æ•°æ®å‡†å¤‡ï¼ˆ1-2å¤©ï¼‰

1. **è®¾è®¡å®Œæ•´è‚¡ç¥¨æ¸…å•**ï¼ˆ80åªï¼‰
   - æŒ‰æ¿å—åˆ†é…æ•°é‡
   - è®¾ç½®åˆç†ä»·æ ¼åŒºé—´
   - é…ç½®æ³¢åŠ¨ç‡å’ŒBeta

2. **ç¼–å†™åˆå§‹åŒ–SQL**
   ```sql
   -- sql_scripts/init_a_stock_market.sql
   -- åŒ…å«80åªè‚¡ç¥¨çš„INSERTè¯­å¥
   ```

3. **ç”Ÿæˆå†å²æ•°æ®**
   ```bash
   python init_historical_data.py --days 90 --market-style a-stock
   ```

### Phase 2: æŒ‡æ•°è®¡ç®—å®ç°ï¼ˆ2-3å¤©ï¼‰

1. **å®ç°æŒ‡æ•°è®¡ç®—å™¨**
   - `backend/lib/index_calculator.py`
   - å®ç°å¸‚å€¼åŠ æƒç®—æ³•
   - å®ç°æˆåˆ†è‚¡é€‰æ‹©é€»è¾‘

2. **é›†æˆåˆ°æ•°æ®ç”Ÿæˆå™¨**
   - æ¯åˆ†é’Ÿç”Ÿæˆè‚¡ç¥¨æ•°æ®åï¼Œè®¡ç®—æŒ‡æ•°
   - åŒæ—¶å†™å…¥ `market_indices` è¡¨

3. **æµ‹è¯•æŒ‡æ•°å‡†ç¡®æ€§**
   - éªŒè¯æƒé‡å’Œä¸º1
   - éªŒè¯æ¶¨è·Œé€»è¾‘æ­£ç¡®

### Phase 3: å¸‚åœºè”åŠ¨æœºåˆ¶ï¼ˆ2-3å¤©ï¼‰

1. **å®ç°å…¨å±€å¸‚åœºçŠ¶æ€**
   - `MarketStateManager` ç±»
   - ç»Ÿä¸€æ§åˆ¶ç‰›ç†Šè½¬æ¢

2. **ä¿®æ”¹ä»·æ ¼ç”Ÿæˆç®—æ³•**
   - æ·»åŠ å¤§ç›˜å½±å“å› å­
   - æ·»åŠ Betaç³»æ•°åº”ç”¨

3. **æµ‹è¯•è”åŠ¨æ•ˆæœ**
   - éªŒè¯å¤§ç›˜æ¶¨æ—¶ï¼Œå¤§éƒ¨åˆ†è‚¡ç¥¨è·Ÿæ¶¨
   - éªŒè¯Betaé«˜çš„è‚¡ç¥¨å¼¹æ€§æ›´å¤§

### Phase 4: å‰ç«¯å±•ç¤ºï¼ˆ3-4å¤©ï¼‰

1. **æŒ‡æ•°çœ‹æ¿**
   - æ˜¾ç¤ºHAPPY300ã€HAPPY50å®æ—¶ç‚¹ä½
   - Kçº¿å›¾å±•ç¤ºæŒ‡æ•°èµ°åŠ¿

2. **æ¿å—çƒ­åŠ›å›¾**
   - æ˜¾ç¤ºå„æ¿å—æ¶¨è·Œ
   - é¢œè‰²æ·±æµ…è¡¨ç¤ºæ¶¨è·Œå¹…

3. **ä¸ªè‚¡é¡µé¢å¢å¼º**
   - æ˜¾ç¤ºæ‰€å±æ¿å—
   - æ˜¾ç¤ºåœ¨æŒ‡æ•°ä¸­çš„æƒé‡
   - æ˜¾ç¤ºBetaç³»æ•°

---

## å…«ã€é¢„æœŸæ•ˆæœ

### 8.1 çœŸå®æ„Ÿæå‡

âœ… **Aè‚¡ç‰¹è‰²**ï¼š
- 6ä½æ•°å­—ä»£ç ï¼ˆ600xxx, 000xxx, 300xxxï¼‰
- ä¸­æ–‡è‚¡ç¥¨åç§°
- çœŸå®çš„è¡Œä¸šæ¿å—åˆ†ç±»
- ç¬¦åˆAè‚¡çš„ä»·æ ¼åŒºé—´å’Œæ³¢åŠ¨ç‰¹å¾

âœ… **å¸‚åœºè”åŠ¨**ï¼š
- å¤§ç›˜æ¶¨ï¼Œå¤šæ•°è‚¡ç¥¨è·Ÿæ¶¨
- ç‰›å¸‚æ¥ä¸´ï¼Œæ¿å—è½®åŠ¨
- ç†Šå¸‚æ—¶ï¼Œæ™®éä¸‹è·Œ

âœ… **ä¸“ä¸šæ€§**ï¼š
- æŒ‡æ•°ä½œä¸ºå¸‚åœºé£å‘æ ‡
- Betaç³»æ•°ä½“ç°é£é™©ç‰¹å¾
- å¸‚å€¼åŠ æƒç¬¦åˆçœŸå®é€»è¾‘

### 8.2 æ•™è‚²ä»·å€¼

ğŸ“š **ç”¨æˆ·å¯ä»¥å­¦ä¹ **ï¼š
- æŒ‡æ•°æˆåˆ†è‚¡çš„æ¦‚å¿µ
- å¤§ç›˜ä¸ä¸ªè‚¡çš„å…³ç³»
- Betaç³»æ•°çš„å«ä¹‰
- æ¿å—è½®åŠ¨çš„è§„å¾‹
- å¸‚å€¼åŠ æƒçš„åŸç†

### 8.3 å¯æ‰©å±•æ€§

ğŸš€ **æœªæ¥å¯ä»¥æ·»åŠ **ï¼š
- è¡Œä¸šæŒ‡æ•°ï¼ˆç§‘æŠ€æŒ‡æ•°ã€é‡‘èæŒ‡æ•°ï¼‰
- ä¸»é¢˜æŒ‡æ•°ï¼ˆæ–°èƒ½æºæŒ‡æ•°ã€èŠ¯ç‰‡æŒ‡æ•°ï¼‰
- é£æ ¼æŒ‡æ•°ï¼ˆå¤§ç›˜è‚¡æŒ‡æ•°ã€å°ç›˜è‚¡æŒ‡æ•°ï¼‰
- åŒ—å‘èµ„é‡‘æµå…¥æµå‡º
- èèµ„èåˆ¸æ•°æ®
- é¾™è™æ¦œæ•°æ®

---

## ä¹ã€æŠ€æœ¯å®ç°è¦ç‚¹

### 9.1 æ€§èƒ½ä¼˜åŒ–

```python
# æŒ‡æ•°è®¡ç®—ä¼˜åŒ–ï¼šä½¿ç”¨ç¼“å­˜

@lru_cache(maxsize=1)
def get_index_constituents(index_code: str) -> List[str]:
    """è·å–æŒ‡æ•°æˆåˆ†è‚¡ï¼ˆå¸¦ç¼“å­˜ï¼‰"""
    # æ¯å°æ—¶æ›´æ–°ä¸€æ¬¡å³å¯ï¼Œä¸éœ€è¦æ¯åˆ†é’ŸæŸ¥è¯¢
    pass

# æ‰¹é‡æŸ¥è¯¢è‚¡ç¥¨ä»·æ ¼
def get_batch_stock_prices(symbols: List[str], timestamp: int) -> Dict[str, float]:
    """æ‰¹é‡æŸ¥è¯¢ï¼Œå‡å°‘æ•°æ®åº“å¾€è¿”"""
    pass
```

### 9.2 æ•°æ®ä¸€è‡´æ€§

```python
# ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§

with db.get_session() as session:
    # 1. ç”Ÿæˆæ‰€æœ‰è‚¡ç¥¨çš„Kçº¿
    klines = generate_all_stocks_klines()
    session.bulk_insert_mappings(MarketKline, klines)

    # 2. è®¡ç®—æŒ‡æ•°
    index_value = calculate_happy300(klines)

    # 3. æ’å…¥æŒ‡æ•°æ•°æ®
    session.add(MarketIndex(
        index_code='HAPPY300',
        time=timestamp,
        value=index_value
    ))

    # 4. æäº¤äº‹åŠ¡ï¼ˆè¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥ï¼‰
    session.commit()
```

---

## åã€æ€»ç»“

è¿™å¥—Aè‚¡é£æ ¼è™šæ‹Ÿå¸‚åœºè®¾è®¡æ–¹æ¡ˆå…·å¤‡ï¼š

âœ… **é«˜åº¦çœŸå®**ï¼š
- å®Œæ•´çš„æ¿å—ä½“ç³»
- ç¬¦åˆAè‚¡ç‰¹å¾çš„ä»£ç å‘½å
- çœŸå®çš„æŒ‡æ•°ç¼–åˆ¶æ–¹æ³•
- å¸‚åœºè”åŠ¨æœºåˆ¶

âœ… **æ•™è‚²ä»·å€¼**ï¼š
- å­¦ä¹ æŒ‡æ•°çš„æ¦‚å¿µ
- ç†è§£å¸‚åœºè”åŠ¨
- æŒæ¡é£é™©åº¦é‡ï¼ˆBetaï¼‰

âœ… **å¯æ‰©å±•æ€§**ï¼š
- æ˜“äºæ·»åŠ æ–°è‚¡ç¥¨
- å¯ä»¥åˆ›å»ºæ–°æŒ‡æ•°
- æ”¯æŒæ›´å¤šå¸‚åœºæœºåˆ¶

âœ… **é›¶é£é™©**ï¼š
- å®Œå…¨è™šæ‹Ÿï¼Œæ— æ³•å¾‹é—®é¢˜
- æ˜ç¡®æ˜¯æ¨¡æ‹Ÿç¯å¢ƒ
- å¯è‡ªç”±é…ç½®å’Œè°ƒæ•´

**ä¸‹ä¸€æ­¥å»ºè®®**ï¼šå…ˆå®ç°æ ¸å¿ƒçš„80åªè‚¡ç¥¨ + HAPPY300æŒ‡æ•°ï¼ŒéªŒè¯è”åŠ¨æ•ˆæœåå†æ‰©å±•å…¶ä»–åŠŸèƒ½ã€‚

ä½ è§‰å¾—è¿™ä¸ªæ–¹æ¡ˆå¦‚ä½•ï¼Ÿéœ€è¦è°ƒæ•´å“ªäº›ç»†èŠ‚ï¼Ÿ
