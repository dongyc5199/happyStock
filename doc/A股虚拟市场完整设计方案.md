# A股虚拟市场完整设计方案

## 项目目标

打造一个**高度仿真的A股模拟交易环境**，包含完整的指数体系、板块分类和上百只虚拟股票，为用户提供零风险的投资学习平台。

---

## 一、市场总体架构

### 1.1 三层架构设计

```
┌─────────────────────────────────────────────────────────┐
│                    指数层（Index Layer）                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐               │
│  │ HAPPY300 │  │ HAPPY50  │  │ GROW100  │               │
│  │快乐综合指数│ │快乐50指数 │ │创新成长指数│              │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘               │
└───────┼─────────────┼─────────────┼──────────────────────┘
        │             │             │
┌───────┼─────────────┼─────────────┼──────────────────────┐
│       │       板块层（Sector Layer）        │             │
│  ┌────▼────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐    │
│  │ 科技板块 │  │ 金融板块 │  │ 消费板块 │  │ 能源板块 │   │
│  │   20只   │  │   12只   │  │   15只   │  │   10只   │   │
│  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘    │
└───────┼────────────┼────────────┼────────────┼──────────┘
        │            │            │            │
┌───────┼────────────┼────────────┼────────────┼──────────┐
│       │      个股层（Stock Layer）           │           │
│  ┌────▼────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐    │
│  │ 600001  │  │ 601318  │  │ 000001  │  │ 300750  │    │
│  │ 快乐银行 │  │ 平安保险 │  │ 深圳科技 │  │ 新能源汽车│   │
│  │ ¥15.00  │  │ ¥58.00  │  │ ¥28.00  │  │ ¥245.00 │    │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘    │
│                     ... 100只股票 ...                     │
└─────────────────────────────────────────────────────────┘
```

### 1.2 规模设计

| 层级 | 数量 | 说明 |
|-----|------|------|
| **核心指数** | 3个 | HAPPY300、HAPPY50、GROW100 |
| **行业指数** | 10个 | 各板块指数 |
| **行业板块** | 10个 | 科技、金融、消费等 |
| **虚拟股票** | 100-120只 | 覆盖所有板块 |
| **市值分层** | 5层 | 超大盘到微盘 |

---

## 二、指数体系设计

### 2.1 三大核心指数

#### （1）HAPPY300 - 快乐综合指数

**定位**：对标沪深300，市场核心指数

| 参数 | 设置 |
|-----|------|
| **代码** | HAPPY300 或 000300 |
| **全称** | 快乐综合指数 |
| **基点** | 3000点 |
| **基期** | 2024-01-01 |
| **成分股数量** | 100只（简化，真实是300） |
| **样本空间** | 全市场 |
| **选样标准** | 市值最大、流动性最好的100只 |
| **加权方式** | 自由流通市值加权 |
| **权重上限** | 单股10%，前5大合计40% |
| **调整频率** | 每季度（3/6/9/12月） |

**成分股权重分布**（目标）：
```
超大权重（5-10%）：  5只，占40%  → 平安、茅台、工行、宁德时代
大权重（2-5%）：    15只，占35%  → 招商、美的、五粮液
中权重（1-2%）：    30只，占20%  → 各行业龙头
小权重（<1%）：     50只，占5%   → 其他成分股
```

#### （2）HAPPY50 - 快乐50指数

**定位**：对标上证50，超大盘蓝筹指数

| 参数 | 设置 |
|-----|------|
| **代码** | HAPPY50 或 000050 |
| **全称** | 快乐50指数 |
| **基点** | 2500点 |
| **成分股数量** | 50只 |
| **选样标准** | HAPPY300中市值最大的50只 |
| **特点** | 低波动、高分红、蓝筹股 |
| **行业分布** | 金融40% + 消费30% + 其他30% |

#### （3）GROW100 - 创新成长指数

**定位**：对标创业板指，高成长股指数

| 参数 | 设置 |
|-----|------|
| **代码** | GROW100 或 399006 |
| **全称** | 创新成长指数 |
| **基点** | 2000点 |
| **成分股数量** | 50只 |
| **选样标准** | 科技、新能源、医药等成长行业 |
| **特点** | 高波动、高成长、高估值 |
| **代码前缀** | 主要是 300xxx（创业板）和 688xxx |

### 2.2 行业指数（10个）

| 指数代码 | 指数名称 | 成分股数量 | 用途 |
|---------|---------|-----------|------|
| TECH | 科技指数 | 20只 | 板块轮动参考 |
| FIN | 金融指数 | 12只 | 经济晴雨表 |
| CONS | 消费指数 | 15只 | 内需指标 |
| NEV | 新能源指数 | 10只 | 主题投资 |
| HEALTH | 医药健康指数 | 12只 | 防御性板块 |
| IND | 工业指数 | 10只 | 周期性板块 |
| REAL | 地产指数 | 8只 | 政策敏感板块 |
| ENERGY | 能源指数 | 8只 | 大宗商品相关 |
| UTIL | 公用事业指数 | 6只 | 稳定收益板块 |
| COMM | 通信指数 | 5只 | 基础设施板块 |

---

## 三、板块体系设计

### 3.1 十大行业板块

| 板块名称 | 板块代码 | 股票数量 | 市值占比 | 平均波动率 | 代表性股票 |
|---------|---------|---------|---------|-----------|-----------|
| **科技板块** | Technology | 20只 | 22% | 3.5% | 芯片、软件、互联网 |
| **金融板块** | Finance | 12只 | 28% | 1.8% | 银行、保险、券商 |
| **消费板块** | Consumer | 15只 | 18% | 2.5% | 白酒、家电、食品 |
| **新能源板块** | NewEnergy | 10只 | 12% | 4.2% | 电动车、光伏、电池 |
| **医药板块** | Healthcare | 12只 | 8% | 2.2% | 创新药、医疗器械 |
| **工业板块** | Industry | 10只 | 5% | 2.8% | 机械、建筑、重工 |
| **地产板块** | RealEstate | 8只 | 3% | 3.0% | 房地产开发 |
| **能源板块** | Energy | 8只 | 2% | 3.2% | 煤炭、石油、天然气 |
| **材料板块** | Materials | 6只 | 1.5% | 2.9% | 化工、钢铁、有色 |
| **公用事业** | Utilities | 5只 | 0.5% | 1.5% | 电力、水务、燃气 |

**总计**：106只股票

### 3.2 市值分层

| 层级 | 市值范围 | 股票数量 | 占比 | 特征 | 代码段 |
|-----|---------|---------|-----|------|--------|
| **超大盘股** | >5000亿 | 10只 | 9% | 权重股、蓝筹 | 601xxx |
| **大盘股** | 1000-5000亿 | 20只 | 19% | 行业龙头 | 600xxx |
| **中盘股** | 300-1000亿 | 35只 | 33% | 成长股 | 000xxx, 002xxx |
| **小盘股** | 100-300亿 | 30只 | 28% | 高成长 | 002xxx, 300xxx |
| **微盘股** | <100亿 | 11只 | 10% | 高风险高收益 | 300xxx |

---

## 四、完整股票清单（106只）

### 4.1 金融板块（12只）- 权重股集中

| 代码 | 名称 | 市值(亿) | 价格(元) | 波动率 | Beta | 流通股本(亿股) | 备注 |
|-----|------|---------|---------|--------|------|--------------|------|
| 601398 | 国民银行 | 12000 | 6.50 | 1.4% | 0.70 | 1846 | 超级权重股 |
| 601318 | 平安保险 | 10000 | 58.00 | 2.0% | 0.75 | 172 | 保险龙头 |
| 600036 | 招商银行 | 9000 | 42.00 | 1.8% | 0.75 | 214 | 零售银行之王 |
| 600001 | 快乐银行 | 8000 | 15.00 | 1.5% | 0.70 | 533 | 四大行之一 |
| 601328 | 交通银行 | 4500 | 8.20 | 1.6% | 0.72 | 549 | 国有大行 |
| 601166 | 城市银行 | 3200 | 9.80 | 1.7% | 0.73 | 327 | 股份制银行 |
| 600030 | 中信证券 | 3800 | 25.00 | 2.5% | 0.85 | 152 | 券商龙头 |
| 601688 | 华泰证券 | 2500 | 18.50 | 2.6% | 0.87 | 135 | 互联网券商 |
| 601066 | 中信建设 | 2100 | 12.30 | 2.3% | 0.82 | 171 | 券商 |
| 601998 | 中信银行 | 3500 | 5.60 | 1.6% | 0.71 | 625 | 股份制银行 |
| 600016 | 民生银行 | 4200 | 4.80 | 1.9% | 0.76 | 875 | 民营银行 |
| 601288 | 农业银行 | 11000 | 4.20 | 1.5% | 0.69 | 2619 | 四大行 |

**板块特征**：
- 市值占比：28%（最大板块）
- 平均Beta：0.75（低于市场平均）
- 分红收益率：4-6%（高分红）
- 在HAPPY300中权重：35%+

### 4.2 消费板块（15只）- 价值股集中

| 代码 | 名称 | 市值(亿) | 价格(元) | 波动率 | Beta | 流通股本(亿股) |
|-----|------|---------|---------|--------|------|--------------|
| 600519 | 贵州快乐 | 22000 | 1680.00 | 2.0% | 0.85 | 13.1 |
| 000858 | 五粮液 | 5800 | 168.00 | 2.2% | 0.88 | 34.5 |
| 600887 | 伊利乳业 | 3200 | 38.00 | 2.3% | 0.90 | 84.2 |
| 000333 | 美的电器 | 5500 | 72.00 | 2.5% | 0.95 | 76.4 |
| 000651 | 格力电器 | 3800 | 35.00 | 2.6% | 0.92 | 108.6 |
| 603288 | 海天调味 | 4200 | 88.00 | 2.4% | 0.87 | 47.7 |
| 002304 | 洋河酒业 | 1800 | 128.00 | 2.8% | 0.93 | 14.1 |
| 600779 | 全聚德 | 420 | 12.00 | 3.2% | 1.05 | 35.0 |
| 002507 | 连锁超市 | 680 | 18.50 | 2.9% | 0.97 | 36.8 |
| 600600 | 青岛啤酒 | 980 | 78.00 | 2.5% | 0.89 | 12.6 |
| 603369 | 今世缘 | 520 | 48.00 | 2.7% | 0.91 | 10.8 |
| 002572 | 家居家电 | 1200 | 52.00 | 3.0% | 1.00 | 23.1 |
| 600809 | 快乐服饰 | 850 | 22.00 | 3.3% | 1.08 | 38.6 |
| 603589 | 食品饮料 | 680 | 35.00 | 2.8% | 0.96 | 19.4 |
| 300999 | 快乐餐饮 | 420 | 28.00 | 3.5% | 1.12 | 15.0 |

### 4.3 科技板块（20只）- 成长股集中

| 代码 | 名称 | 市值(亿) | 价格(元) | 波动率 | Beta | 流通股本(亿股) |
|-----|------|---------|---------|--------|------|--------------|
| 600519 | 云端计算 | 5000 | 180.00 | 3.0% | 1.15 | 27.8 |
| 688001 | 半导体芯片 | 3500 | 120.00 | 4.2% | 1.35 | 29.2 |
| 688012 | 人工智能 | 2800 | 95.00 | 4.5% | 1.40 | 29.5 |
| 300059 | 互联网科技 | 4200 | 68.00 | 3.8% | 1.28 | 61.8 |
| 300750 | 智能硬件 | 1500 | 52.00 | 4.0% | 1.32 | 28.8 |
| 002415 | 视频监控 | 3000 | 48.00 | 3.5% | 1.22 | 62.5 |
| 002230 | 通信设备 | 1800 | 38.00 | 3.6% | 1.25 | 47.4 |
| 300033 | 云存储 | 1200 | 45.00 | 4.2% | 1.38 | 26.7 |
| 603986 | 软件开发 | 980 | 32.00 | 3.9% | 1.30 | 30.6 |
| 688111 | 量子计算 | 650 | 88.00 | 5.5% | 1.65 | 7.4 |
| 688188 | 光刻机 | 520 | 220.00 | 6.0% | 1.75 | 2.4 |
| 300456 | 大数据 | 1100 | 28.00 | 4.1% | 1.33 | 39.3 |
| 002049 | 紫光芯片 | 2200 | 42.00 | 4.3% | 1.36 | 52.4 |
| 603160 | 电子元件 | 880 | 25.00 | 3.7% | 1.24 | 35.2 |
| 300661 | 5G通信 | 1350 | 38.00 | 4.0% | 1.31 | 35.5 |
| 002371 | 北方华创 | 1800 | 78.00 | 4.8% | 1.42 | 23.1 |
| 688008 | 集成电路 | 980 | 56.00 | 5.2% | 1.55 | 17.5 |
| 300142 | 物联网 | 720 | 18.50 | 4.4% | 1.37 | 38.9 |
| 688036 | 工业软件 | 560 | 42.00 | 4.6% | 1.45 | 13.3 |
| 300308 | 网络安全 | 890 | 28.00 | 4.2% | 1.34 | 31.8 |

### 4.4 新能源板块（10只）- 热门赛道

| 代码 | 名称 | 市值(亿) | 价格(元) | 波动率 | Beta | 流通股本(亿股) |
|-----|------|---------|---------|--------|------|--------------|
| 300750 | 新能源汽车 | 8000 | 245.00 | 4.5% | 1.50 | 32.7 |
| 002594 | 动力电池 | 4500 | 180.00 | 4.8% | 1.55 | 25.0 |
| 601012 | 光伏科技 | 3200 | 85.00 | 4.2% | 1.42 | 37.6 |
| 600438 | 风力发电 | 1800 | 28.00 | 3.8% | 1.35 | 64.3 |
| 300274 | 储能技术 | 2100 | 95.00 | 5.0% | 1.58 | 22.1 |
| 688599 | 锂电材料 | 1500 | 120.00 | 5.2% | 1.62 | 12.5 |
| 002129 | 充电桩 | 980 | 42.00 | 4.6% | 1.48 | 23.3 |
| 300014 | 氢能源 | 720 | 35.00 | 5.5% | 1.68 | 20.6 |
| 601865 | 太阳能 | 1200 | 18.50 | 4.0% | 1.38 | 64.9 |
| 688303 | 钠电池 | 380 | 68.00 | 6.0% | 1.80 | 5.6 |

### 4.5 医药板块（12只）

| 代码 | 名称 | 市值(亿) | 价格(元) | 波动率 | Beta | 流通股本(亿股) |
|-----|------|---------|---------|--------|------|--------------|
| 600276 | 生物医药 | 3800 | 88.00 | 2.5% | 0.95 | 43.2 |
| 000661 | 长春制药 | 2200 | 45.00 | 2.8% | 1.00 | 48.9 |
| 002007 | 华东医药 | 1500 | 32.00 | 2.6% | 0.97 | 46.9 |
| 300015 | 创新药 | 2800 | 68.00 | 3.2% | 1.12 | 41.2 |
| 603259 | 医疗器械 | 1200 | 58.00 | 2.9% | 1.05 | 20.7 |
| 688180 | 基因测序 | 680 | 95.00 | 4.0% | 1.30 | 7.2 |
| 300529 | 中药制造 | 980 | 28.00 | 2.7% | 0.98 | 35.0 |
| 600521 | 疫苗研发 | 1800 | 78.00 | 3.5% | 1.18 | 23.1 |
| 002773 | 医疗服务 | 720 | 42.00 | 3.0% | 1.08 | 17.1 |
| 688396 | 细胞治疗 | 450 | 120.00 | 4.8% | 1.45 | 3.8 |
| 603392 | 保健品 | 580 | 25.00 | 2.8% | 1.02 | 23.2 |
| 300347 | 医药流通 | 1100 | 15.50 | 2.4% | 0.92 | 71.0 |

### 4.6 工业板块（10只）

| 代码 | 名称 | 市值(亿) | 价格(元) | 波动率 | Beta | 流通股本(亿股) |
|-----|------|---------|---------|--------|------|--------------|
| 601668 | 中国建筑 | 4500 | 6.80 | 2.5% | 0.88 | 662 |
| 600585 | 机械制造 | 2200 | 28.00 | 3.0% | 1.05 | 78.6 |
| 601766 | 航空航天 | 1800 | 35.00 | 3.2% | 1.10 | 51.4 |
| 600031 | 重工集团 | 3200 | 12.50 | 2.8% | 0.98 | 256 |
| 600150 | 船舶制造 | 1500 | 18.00 | 3.4% | 1.12 | 83.3 |
| 002202 | 工程机械 | 980 | 22.00 | 3.1% | 1.07 | 44.5 |
| 601919 | 高铁装备 | 2800 | 8.50 | 2.6% | 0.92 | 329 |
| 603766 | 电气设备 | 720 | 42.00 | 3.3% | 1.09 | 17.1 |
| 600875 | 化工材料 | 1200 | 25.00 | 3.5% | 1.15 | 48.0 |
| 002459 | 通用机械 | 680 | 15.50 | 3.2% | 1.08 | 43.9 |

### 4.7 地产板块（8只）

| 代码 | 名称 | 市值(亿) | 价格(元) | 波动率 | Beta | 流通股本(亿股) |
|-----|------|---------|---------|--------|------|--------------|
| 000002 | 万科地产 | 2800 | 18.50 | 3.5% | 1.18 | 151 |
| 600048 | 保利发展 | 2200 | 15.00 | 3.3% | 1.15 | 147 |
| 001979 | 招商蛇口 | 1500 | 12.80 | 3.2% | 1.12 | 117 |
| 600383 | 金地集团 | 680 | 9.50 | 3.8% | 1.25 | 71.6 |
| 000667 | 美好置业 | 420 | 6.20 | 4.2% | 1.35 | 67.7 |
| 600340 | 华夏幸福 | 850 | 8.80 | 4.0% | 1.28 | 96.6 |
| 600606 | 绿地控股 | 1200 | 5.60 | 3.6% | 1.20 | 214 |
| 600895 | 张江高科 | 380 | 18.00 | 3.4% | 1.16 | 21.1 |

### 4.8 能源板块（8只）

| 代码 | 名称 | 市值(亿) | 价格(元) | 波动率 | Beta | 流通股本(亿股) |
|-----|------|---------|---------|--------|------|--------------|
| 601857 | 中国石油 | 8500 | 6.20 | 2.8% | 0.95 | 1371 |
| 600028 | 中国石化 | 7200 | 5.80 | 2.6% | 0.92 | 1241 |
| 601088 | 中国神华 | 5800 | 28.50 | 3.2% | 1.08 | 204 |
| 601225 | 陕西煤业 | 2200 | 18.00 | 3.5% | 1.15 | 122 |
| 600188 | 兖矿能源 | 1800 | 22.00 | 3.4% | 1.12 | 81.8 |
| 601898 | 中煤能源 | 1500 | 8.50 | 3.0% | 1.05 | 176 |
| 600348 | 华阳股份 | 680 | 15.00 | 3.6% | 1.18 | 45.3 |
| 601699 | 潞安环能 | 520 | 12.50 | 3.3% | 1.10 | 41.6 |

### 4.9 材料板块（6只）

| 代码 | 名称 | 市值(亿) | 价格(元) | 波动率 | Beta | 流通股本(亿股) |
|-----|------|---------|---------|--------|------|--------------|
| 600019 | 宝钢股份 | 3800 | 8.50 | 2.8% | 1.00 | 447 |
| 601600 | 中国铝业 | 1800 | 5.20 | 3.5% | 1.20 | 346 |
| 000630 | 铜陵有色 | 980 | 3.80 | 3.8% | 1.28 | 258 |
| 600309 | 万华化学 | 2800 | 95.00 | 3.2% | 1.12 | 29.5 |
| 600426 | 华鲁恒升 | 1200 | 28.00 | 3.0% | 1.08 | 42.9 |
| 600352 | 浙江龙盛 | 680 | 12.50 | 2.9% | 1.05 | 54.4 |

### 4.10 公用事业板块（5只）

| 代码 | 名称 | 市值(亿) | 价格(元) | 波动率 | Beta | 流通股本(亿股) |
|-----|------|---------|---------|--------|------|--------------|
| 600900 | 长江电力 | 5200 | 22.50 | 1.5% | 0.65 | 231 |
| 600886 | 国投电力 | 1800 | 12.00 | 1.8% | 0.72 | 150 |
| 600011 | 华能国际 | 2200 | 8.50 | 2.0% | 0.78 | 259 |
| 601985 | 中国核电 | 1500 | 6.80 | 1.6% | 0.68 | 221 |
| 600027 | 华电国际 | 980 | 5.50 | 1.9% | 0.75 | 178 |

### 4.11 通信板块（5只）

| 代码 | 名称 | 市值(亿) | 价格(元) | 波动率 | Beta | 流通股本(亿股) |
|-----|------|---------|---------|--------|------|--------------|
| 600050 | 中国联通 | 2800 | 4.20 | 2.2% | 0.85 | 667 |
| 600941 | 中国移动 | 18000 | 85.00 | 1.8% | 0.75 | 212 |
| 601728 | 中国电信 | 4500 | 5.50 | 2.0% | 0.80 | 818 |
| 600764 | 中电广通 | 680 | 18.00 | 2.5% | 0.92 | 37.8 |
| 600498 | 烽火通信 | 520 | 22.00 | 2.8% | 0.98 | 23.6 |

---

## 五、价格生成机制

### 5.1 分层价格生成策略

```python
class HierarchicalPriceGenerator:
    """
    三层价格生成：全市场 → 板块 → 个股
    """

    def generate_daily_prices(self):
        # 第1层：全市场状态
        market_state = self.get_global_market_state()  # 牛市/熊市/横盘
        market_trend = self.get_market_trend(market_state)  # -2% 到 +2%

        # 第2层：板块联动
        sector_trends = {}
        for sector in SECTORS:
            # 板块趋势 = 市场趋势 × 板块Beta + 板块自身波动
            sector_beta = SECTOR_BETAS[sector]
            sector_trend = (market_trend * sector_beta * 0.5 +
                          random.normal(0, SECTOR_VOLATILITY[sector]) * 0.5)
            sector_trends[sector] = sector_trend

        # 第3层：个股价格
        for stock in self.stocks:
            # 个股价格 = 市场影响(30%) + 板块影响(30%) + 个股波动(40%)
            market_component = market_trend * stock.beta * 0.3
            sector_component = sector_trends[stock.sector] * 0.3
            individual_component = self.gbm_generate(stock) * 0.4

            price_change = market_component + sector_component + individual_component
            new_price = stock.current_price * (1 + price_change)

            stock.update_price(new_price)
```

### 5.2 板块Beta系数

| 板块 | 板块Beta | 说明 |
|-----|---------|------|
| 金融 | 0.75 | 跟随性中等，防御性较强 |
| 消费 | 0.85 | 相对稳定 |
| 科技 | 1.25 | 高弹性，大盘涨它涨更多 |
| 新能源 | 1.40 | 超高弹性 |
| 医药 | 0.90 | 防御性板块 |
| 工业 | 1.05 | 周期性，跟随大盘 |
| 地产 | 1.15 | 周期性强 |
| 能源 | 0.95 | 周期性 |
| 材料 | 1.10 | 周期性 |
| 公用事业 | 0.65 | 防御性最强 |

### 5.3 市场联动效果示例

**场景**：大盘上涨1%（HAPPY300 +1%）

```
各板块表现：
公用事业：+0.65% × 板块影响 ≈ +0.5%  （抗涨）
金融板块：+0.75% × 板块影响 ≈ +0.7%  （稳健跟随）
消费板块：+0.85% × 板块影响 ≈ +0.8%
工业板块：+1.05% × 板块影响 ≈ +1.0%  （同步）
科技板块：+1.25% × 板块影响 ≈ +1.3%  （弹性大）
新能源板块：+1.40% × 板块影响 ≈ +1.5%  （领涨）

个股表现（举例）：
600900 长江电力（Beta=0.65）：+0.5% 左右
601398 国民银行（Beta=0.70）：+0.7% 左右
688001 半导体芯片（Beta=1.35）：+1.8% 左右
300750 新能源汽车（Beta=1.50）：+2.2% 左右
```

---

## 六、指数计算实现

### 6.1 数据库表结构

```sql
-- 1. 市场指数表
CREATE TABLE market_indices (
    id SERIAL PRIMARY KEY,
    index_code VARCHAR(20) NOT NULL,        -- HAPPY300
    index_name VARCHAR(50) NOT NULL,        -- 快乐综合指数
    time BIGINT NOT NULL,                    -- 时间戳
    value NUMERIC(10, 2) NOT NULL,          -- 指数点位
    change_value NUMERIC(10, 2),            -- 涨跌点数
    change_pct NUMERIC(6, 3),               -- 涨跌幅(%)
    volume BIGINT,                           -- 成交量（亿股）
    amount BIGINT,                           -- 成交额（亿元）
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(index_code, time)
);

-- 2. 指数成分股表
CREATE TABLE index_constituents (
    id SERIAL PRIMARY KEY,
    index_code VARCHAR(20) NOT NULL,        -- HAPPY300
    stock_symbol VARCHAR(20) NOT NULL,      -- 600001
    weight NUMERIC(6, 4) NOT NULL,          -- 权重 0.0850
    rank INTEGER,                            -- 排名
    join_date DATE DEFAULT CURRENT_DATE,    -- 纳入日期
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(index_code, stock_symbol)
);

-- 3. 扩展股票元数据表
ALTER TABLE stock_metadata ADD COLUMN IF NOT EXISTS
    outstanding_shares BIGINT DEFAULT 1000000000,  -- 流通股本（股）
    market_cap BIGINT,                              -- 总市值（亿元）
    beta NUMERIC(4, 2) DEFAULT 1.0,                -- Beta系数
    weight_in_happy300 NUMERIC(6, 4),              -- 在HAPPY300中的权重
    is_happy300_constituent BOOLEAN DEFAULT FALSE, -- 是否是HAPPY300成分股
    sector_code VARCHAR(20),                        -- 板块代码
    listing_date DATE DEFAULT '2024-01-01';        -- 上市日期
```

### 6.2 指数计算流程

```python
# backend/lib/index_calculator.py

class HAPPY300Calculator:
    """HAPPY300指数计算器"""

    def __init__(self, db_manager):
        self.db = db_manager
        self.base_point = 3000
        self.weight_cap = 0.10
        self.divisor = None  # 首次计算时初始化

    def select_constituents(self) -> List[str]:
        """
        选择成分股（市值最大的100只）

        Returns:
            成分股代码列表
        """
        with self.db.get_session() as session:
            # 按市值降序排列，取前100只
            stocks = session.query(StockMetadata).filter(
                StockMetadata.is_active == True
            ).order_by(
                StockMetadata.market_cap.desc()
            ).limit(100).all()

            return [s.symbol for s in stocks]

    def calculate_weights(self, stocks: List[Stock]) -> Dict[str, float]:
        """
        计算权重（应用10%上限）

        Returns:
            {股票代码: 权重}
        """
        # 1. 计算总市值
        total_cap = sum(s.market_cap for s in stocks)

        # 2. 计算初始权重
        initial_weights = {
            s.symbol: s.market_cap / total_cap
            for s in stocks
        }

        # 3. 应用权重上限
        adjusted = {
            sym: min(w, self.weight_cap)
            for sym, w in initial_weights.items()
        }

        # 4. 归一化
        total = sum(adjusted.values())
        final = {sym: w / total for sym, w in adjusted.items()}

        return final

    def calculate_index(self, timestamp: int) -> float:
        """
        计算当前指数值

        Args:
            timestamp: 当前时间戳

        Returns:
            指数点位
        """
        # 1. 获取成分股
        constituents = self.select_constituents()

        # 2. 获取当前价格
        stocks = []
        for symbol in constituents:
            price = self.get_stock_price(symbol, timestamp)
            meta = self.get_stock_metadata(symbol)
            market_cap = price * meta.outstanding_shares / 100000000  # 转亿元

            stocks.append(Stock(
                symbol=symbol,
                price=price,
                market_cap=market_cap
            ))

        # 3. 计算权重
        weights = self.calculate_weights(stocks)

        # 4. 计算调整市值
        total_adjusted_cap = 0
        for stock in stocks:
            initial_weight = stock.market_cap / sum(s.market_cap for s in stocks)
            if initial_weight > self.weight_cap:
                weight_factor = self.weight_cap / initial_weight
            else:
                weight_factor = 1.0

            adjusted_cap = stock.market_cap * weight_factor
            total_adjusted_cap += adjusted_cap

        # 5. 计算指数
        if self.divisor is None:
            # 首次计算，初始化除数
            self.divisor = total_adjusted_cap / self.base_point

        index_value = total_adjusted_cap / self.divisor

        return round(index_value, 2)

    def save_index_value(self, timestamp: int, value: float):
        """保存指数值到数据库"""
        # 获取前一个值计算涨跌
        prev_value = self.get_previous_value('HAPPY300')

        change = value - prev_value
        change_pct = (change / prev_value) * 100 if prev_value else 0

        with self.db.get_session() as session:
            index_data = MarketIndex(
                index_code='HAPPY300',
                index_name='快乐综合指数',
                time=timestamp,
                value=value,
                change_value=round(change, 2),
                change_pct=round(change_pct, 2)
            )
            session.add(index_data)
            session.commit()
```

---

## 七、实施路线图

### Phase 1：基础数据准备（3-4天）

**任务**：
1. ✅ 设计完整106只股票清单
2. ✅ 编写数据库初始化SQL
3. ⬜ 实现股票数据导入脚本
4. ⬜ 生成90天历史K线数据

**交付物**：
- `sql_scripts/init_a_stock_market.sql`（106只股票）
- `backend/init_historical_data.py`（历史数据生成）
- 数据库中有完整的90天数据

### Phase 2：指数计算实现（3-4天）

**任务**：
1. ⬜ 实现 `HAPPY300Calculator` 类
2. ⬜ 集成到数据生成守护进程
3. ⬜ 每分钟计算指数并写入数据库
4. ⬜ 实现指数历史数据回填

**交付物**：
- `backend/lib/index_calculator.py`
- `market_indices` 表有完整数据
- `index_constituents` 表有权重信息

### Phase 3：市场联动机制（2-3天）

**任务**：
1. ⬜ 实现全局市场状态管理
2. ⬜ 修改价格生成算法（加入大盘/板块影响）
3. ⬜ 设置各板块Beta系数
4. ⬜ 测试联动效果

**交付物**：
- `backend/lib/market_state_manager.py`
- 修改后的 `price_generator.py`
- 联动效果测试报告

### Phase 4：前端展示（4-5天）

**任务**：
1. ⬜ 指数看板组件（显示HAPPY300/50/GROW100）
2. ⬜ 板块热力图（10大板块涨跌）
3. ⬜ 个股详情页增强（板块、Beta、指数权重）
4. ⬜ 指数K线图

**交付物**：
- `frontend/src/components/index/IndexDashboard.tsx`
- `frontend/src/components/index/SectorHeatMap.tsx`
- 完整的前端展示页面

---

## 八、预期效果

### 8.1 真实感

✅ **完整的A股市场特征**：
- 106只股票，10大板块
- 6位数字代码（600xxx, 300xxx等）
- 市值从380亿到22000亿，真实分布
- Beta从0.65到1.80，风险分层明确

✅ **市场联动**：
- 大盘涨1%，80%+股票跟涨
- 板块轮动（科技领涨、金融防守）
- 牛熊周期（全市场状态切换）

✅ **专业指数**：
- HAPPY300反映市场整体
- HAPPY50反映蓝筹走势
- GROW100反映成长股

### 8.2 教育价值

📚 **用户可以学习**：
- 指数成分股的概念
- 大盘与个股的关系
- Beta系数与风险
- 板块轮动策略
- 市值加权原理
- 牛熊市特征

### 8.3 可扩展性

🚀 **未来扩展**：
- 增加到300只股票（完整HAPPY300）
- 添加行业指数（科技指数、新能源指数）
- 加入北向资金、融资融券
- 实现分红派息
- 添加停牌、涨跌停限制
- 模拟IPO、退市

---

## 九、关键决策点

### 决策1：股票数量

**选项**：
- A. 50只（快速验证）
- B. 106只（本方案，推荐）✅
- C. 300只（完整版，后期扩展）

**推荐理由**：106只是最佳平衡点
- 足够覆盖所有板块
- 数据量适中，便于管理
- 能形成有效的指数
- 可扩展到300只

### 决策2：指数数量

**选项**：
- A. 仅HAPPY300
- B. HAPPY300 + HAPPY50 + GROW100（推荐）✅
- C. 再加10个行业指数

**推荐理由**：3个核心指数
- 满足基本需求
- 代表不同风格
- 实现难度适中

### 决策3：联动复杂度

**选项**：
- A. 无联动（个股独立）
- B. 市场联动（本方案）✅
- C. 市场+板块+事件联动

**推荐理由**：市场联动足够
- 真实感显著提升
- 实现复杂度可控
- 教育价值高

---

## 十、总结

本方案设计了一个**高度仿真的A股虚拟市场**：

✅ **规模**：106只股票，10大板块，3大指数
✅ **真实性**：A股代码、市值分布、Beta系数、市场联动
✅ **专业性**：市值加权指数、权重上限、除数调整
✅ **教育性**：用户可学习指数、板块、Beta等核心概念
✅ **可扩展**：易于增加股票、指数、市场机制

**总开发周期**：约2-3周
**技术难点**：指数计算、市场联动、历史数据生成
**核心价值**：零风险学习投资，高度接近真实A股

---

**准备开始实施了吗？需要我先做哪一部分？**
