# æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆç³»ç»Ÿå®ç°æ€»ç»“

## æ¦‚è¿°

å·²å®Œæˆæ¨¡æ‹Ÿè‚¡ç¥¨æ•°æ®ç”Ÿæˆç³»ç»Ÿçš„å®Œæ•´å®ç°ï¼ŒåŒ…æ‹¬æ•°æ®åº“è®¾è®¡ã€ä»·æ ¼ç”Ÿæˆç®—æ³•ã€å®ˆæŠ¤è¿›ç¨‹ã€æ•°æ®èšåˆå’Œå†å²æ•°æ®åˆå§‹åŒ–ã€‚

## å®ç°æ–‡ä»¶æ¸…å•

### 1. æ•°æ®åº“ç›¸å…³

#### `sql_scripts/create_market_data_tables.sql`
å®Œæ•´çš„æ•°æ®åº“è¡¨ç»“æ„å®šä¹‰ï¼ˆPostgreSQLï¼‰ï¼š

- **market_klines** - åˆ†åŒºKçº¿æ•°æ®è¡¨
  - æŒ‰æœˆåˆ†åŒºï¼ˆ2025å¹´å…¨å¹´ï¼‰
  - åŒ…å«è¦†ç›–ç´¢å¼•ï¼ˆsymbol, interval, time + OHLCVï¼‰
  - ä¸»é”®ï¼š(symbol, interval, time)

- **stock_state** - è‚¡ç¥¨çŠ¶æ€è¡¨
  - å½“å‰ä»·æ ¼ã€æ³¢åŠ¨ç‡ã€è¶‹åŠ¿ã€å¸‚åœºçŠ¶æ€
  - å®æ—¶æ›´æ–°æ¯ä¸ªè‚¡ç¥¨çš„çŠ¶æ€

- **market_status** - å¸‚åœºçŠ¶æ€è¡¨
  - è®°å½•äº¤æ˜“æ—¶æ®µçŠ¶æ€ï¼ˆå¼€ç›˜/æ”¶ç›˜ï¼‰
  - å½“å‰æ—¶æ®µï¼ˆä¸Šåˆ/ä¸‹åˆ/ä¼‘å¸‚ï¼‰

- **stock_realtime_price** - å®æ—¶ä»·æ ¼ç¼“å­˜è¡¨
  - UNLOGGEDè¡¨ï¼Œé«˜æ€§èƒ½
  - ç”¨äºå¿«é€ŸæŸ¥è¯¢æœ€æ–°ä»·æ ¼

- **stock_metadata** - è‚¡ç¥¨å…ƒæ•°æ®è¡¨
  - é¢„ç½®10åªæ¨¡æ‹Ÿè‚¡ç¥¨ï¼ˆAAPL, TSLA, MSFTç­‰ï¼‰
  - åŸºç¡€ä»·æ ¼ã€æ³¢åŠ¨ç‡ã€è¡Œä¸šåˆ†ç±»

### 2. æ ¸å¿ƒç®—æ³•

#### `backend/lib/price_generator.py`
ä»·æ ¼ç”Ÿæˆç®—æ³•å®ç°ï¼š

**æ ¸å¿ƒç±»**ï¼š
- `PriceGenerator` - åŸºäºå‡ ä½•å¸ƒæœ—è¿åŠ¨çš„ä»·æ ¼ç”Ÿæˆå™¨
- `MarketState` - å¸‚åœºçŠ¶æ€æšä¸¾ï¼ˆç‰›å¸‚/ç†Šå¸‚/æ¨ªç›˜ï¼‰

**å…³é”®åŠŸèƒ½**ï¼š
```python
# ç”Ÿæˆä¸‹ä¸€æ ¹Kçº¿
generate_next_kline(
    current_price: float,
    market_state: MarketState,
    base_volume: int,
    dt: float = 1/240  # 1åˆ†é’Ÿ
) -> Dict[str, float]  # è¿”å› OHLCV

# ç”ŸæˆKçº¿åºåˆ—ï¼ˆå«çŠ¶æ€è½¬æ¢ï¼‰
generate_kline_sequence(
    initial_price: float,
    num_bars: int,
    initial_state: MarketState,
    base_volume: int
) -> Tuple[list, MarketState]
```

**ç®—æ³•ç‰¹æ€§**ï¼š
- **å‡ ä½•å¸ƒæœ—è¿åŠ¨**ï¼šdS = Î¼S dt + ÏƒS dW
  - Î¼ = è¶‹åŠ¿ï¼ˆdriftï¼‰
  - Ïƒ = æ³¢åŠ¨ç‡ï¼ˆvolatilityï¼‰
  - dW = ç»´çº³è¿‡ç¨‹ï¼ˆéšæœºæ¸¸èµ°ï¼‰

- **é©¬å°”å¯å¤«çŠ¶æ€è½¬æ¢**ï¼š
  - ç‰›å¸‚ â†’ ç‰›å¸‚: 90%, æ¨ªç›˜: 8%, ç†Šå¸‚: 2%
  - ç†Šå¸‚ â†’ ç†Šå¸‚: 90%, æ¨ªç›˜: 8%, ç‰›å¸‚: 2%
  - æ¨ªç›˜ â†’ ç‰›å¸‚: 15%, æ¨ªç›˜: 70%, ç†Šå¸‚: 15%
  - è½¬æ¢é—´éš”ï¼š30-120åˆ†é’Ÿéšæœº

- **å¸‚åœºçŠ¶æ€å‚æ•°**ï¼š
  - ç‰›å¸‚ï¼šè¶‹åŠ¿ +15%/å¹´ï¼Œæ³¢åŠ¨ç‡ 1.0x
  - ç†Šå¸‚ï¼šè¶‹åŠ¿ -15%/å¹´ï¼Œæ³¢åŠ¨ç‡ 1.5x
  - æ¨ªç›˜ï¼šè¶‹åŠ¿ 0%ï¼Œæ³¢åŠ¨ç‡ 0.8x

- **æˆäº¤é‡ç”Ÿæˆ**ï¼š
  - åŸºç¡€æˆäº¤é‡ Ã— (1 + ä»·æ ¼å˜åŒ–% Ã— 10)
  - éšæœºå™ªå£°ï¼š0.7-1.3å€
  - æœ€å°æˆäº¤é‡ï¼šåŸºç¡€æˆäº¤é‡çš„30%

### 3. æ•°æ®åº“æ¨¡å‹

#### `backend/lib/db_models.py`
SQLAlchemy ORMæ¨¡å‹å’Œè¿æ¥ç®¡ç†ï¼š

**æ ¸å¿ƒç±»**ï¼š
- `DatabaseManager` - æ•°æ®åº“è¿æ¥ç®¡ç†å™¨
  - è¿æ¥æ± é…ç½®ï¼špool_size=20, max_overflow=30
  - PostgreSQL / SQLite è‡ªåŠ¨è¯†åˆ«
  - æ”¯æŒæ‰¹é‡æ’å…¥ä¼˜åŒ–

**æ¨¡å‹å®šä¹‰**ï¼š
- `MarketKline` - Kçº¿æ•°æ®æ¨¡å‹
- `StockState` - è‚¡ç¥¨çŠ¶æ€æ¨¡å‹
- `MarketStatus` - å¸‚åœºçŠ¶æ€æ¨¡å‹
- `StockRealtimePrice` - å®æ—¶ä»·æ ¼æ¨¡å‹
- `StockMetadata` - è‚¡ç¥¨å…ƒæ•°æ®æ¨¡å‹

**å…³é”®æ–¹æ³•**ï¼š
```python
# æ‰¹é‡æ’å…¥Kçº¿æ•°æ®
bulk_insert_klines(klines: List[Dict]) -> int

# æ›´æ–°è‚¡ç¥¨çŠ¶æ€
update_stock_state(
    symbol: str,
    current_price: float,
    volatility: float,
    trend: float,
    market_state: str,
    timestamp: int
)

# è·å–æ´»è·ƒè‚¡ç¥¨åˆ—è¡¨
get_active_stocks() -> List[StockMetadata]
```

### 4. å¸‚åœºæ•°æ®ç”Ÿæˆå®ˆæŠ¤è¿›ç¨‹

#### `backend/lib/market_data_generator.py`
ä¸»å®ˆæŠ¤è¿›ç¨‹å®ç°ï¼š

**æ ¸å¿ƒç±»**ï¼š
- `MarketDataGenerator` - å¸‚åœºæ•°æ®ç”Ÿæˆå®ˆæŠ¤è¿›ç¨‹

**äº¤æ˜“æ—¶æ®µ**ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰ï¼š
- ä¸Šåˆï¼š9:30 - 11:30ï¼ˆ120åˆ†é’Ÿï¼‰
- ä¸‹åˆï¼š13:00 - 15:00ï¼ˆ120åˆ†é’Ÿï¼‰
- å‘¨æœ«å’Œéäº¤æ˜“æ—¶æ®µè‡ªåŠ¨ä¼‘å¸‚

**å·¥ä½œæµç¨‹**ï¼š
1. æ¯åˆ†é’Ÿæ£€æŸ¥æ˜¯å¦åœ¨äº¤æ˜“æ—¶æ®µ
2. å¦‚åœ¨äº¤æ˜“æ—¶æ®µï¼š
   - ä¸ºæ‰€æœ‰æ´»è·ƒè‚¡ç¥¨ç”Ÿæˆ1åˆ†é’ŸKçº¿
   - æ£€æŸ¥å¸‚åœºçŠ¶æ€è½¬æ¢
   - æ‰¹é‡æ’å…¥æ•°æ®åº“
   - æ›´æ–°è‚¡ç¥¨çŠ¶æ€
3. ä¼˜é›…å…³é—­å¤„ç†ï¼ˆSIGINT/SIGTERMï¼‰

**è¿è¡Œæ¨¡å¼**ï¼š
- æ­£å¸¸æ¨¡å¼ï¼šéµå®ˆäº¤æ˜“æ—¶æ®µ
- æµ‹è¯•æ¨¡å¼ï¼ˆ--testï¼‰ï¼šæŒç»­ç”Ÿæˆï¼Œæ— æ—¶é—´é™åˆ¶

### 5. æ•°æ®èšåˆæ¨¡å—

#### `backend/lib/data_aggregator.py`
æ•°æ®èšåˆå®ç°ï¼š

**æ ¸å¿ƒç±»**ï¼š
- `DataAggregator` - æ•°æ®èšåˆå™¨

**æ”¯æŒçš„æ—¶é—´å‘¨æœŸ**ï¼š
- 5m, 15m, 30m, 60m, 120m
- æœªæ¥æ‰©å±•ï¼š1d, 1w, 1M

**èšåˆè§„åˆ™**ï¼š
- Openï¼šç¬¬ä¸€æ ¹Kçº¿çš„å¼€ç›˜ä»·
- Highï¼šæ‰€æœ‰Kçº¿çš„æœ€é«˜ä»·
- Lowï¼šæ‰€æœ‰Kçº¿çš„æœ€ä½ä»·
- Closeï¼šæœ€åä¸€æ ¹Kçº¿çš„æ”¶ç›˜ä»·
- Volumeï¼šæ‰€æœ‰Kçº¿æˆäº¤é‡ä¹‹å’Œ

**å…³é”®æ–¹æ³•**ï¼š
```python
# èšåˆå•ä¸ªè‚¡ç¥¨çš„å•ä¸ªå‘¨æœŸ
aggregate_klines(
    symbol: str,
    source_interval: str = "1m",
    target_interval: str = "5m",
    start_time: Optional[int] = None,
    end_time: Optional[int] = None
) -> List[Dict]

# èšåˆæ‰€æœ‰å‘¨æœŸ
aggregate_all_intervals(symbol: str, lookback_hours: int = 24)

# èšåˆæ‰€æœ‰è‚¡ç¥¨
aggregate_all_stocks(lookback_hours: int = 24)
```

### 6. å¯åŠ¨è„šæœ¬

#### `backend/start_market_generator.py`
å¸‚åœºæ•°æ®ç”Ÿæˆå™¨å¯åŠ¨è„šæœ¬

```bash
# æ­£å¸¸æ¨¡å¼ï¼ˆéµå®ˆäº¤æ˜“æ—¶æ®µï¼‰
python start_market_generator.py

# æµ‹è¯•æ¨¡å¼ï¼ˆæŒç»­ç”Ÿæˆï¼‰
python start_market_generator.py --test

# è¯¦ç»†æ—¥å¿—
python start_market_generator.py --verbose

# è‡ªå®šä¹‰æ•°æ®åº“
python start_market_generator.py --db-url postgresql://user:pass@host/db
```

#### `backend/start_aggregator.py`
æ•°æ®èšåˆå™¨å¯åŠ¨è„šæœ¬

```bash
# æ¯5åˆ†é’Ÿèšåˆä¸€æ¬¡
python start_aggregator.py --interval 5

# æ¯10åˆ†é’Ÿèšåˆä¸€æ¬¡
python start_aggregator.py --interval 10
```

### 7. å†å²æ•°æ®åˆå§‹åŒ–

#### `backend/init_historical_data.py`
å†å²æ•°æ®ç”Ÿæˆè„šæœ¬ï¼š

**åŠŸèƒ½**ï¼š
- ç”ŸæˆæŒ‡å®šå¤©æ•°çš„å†å²Kçº¿æ•°æ®
- è‡ªåŠ¨è·³è¿‡å‘¨æœ«
- æ¨¡æ‹ŸçœŸå®äº¤æ˜“æ—¶æ®µ
- è‡ªåŠ¨æ‰§è¡Œæ•°æ®èšåˆ

**ä½¿ç”¨æ–¹æ³•**ï¼š
```bash
# ç”Ÿæˆ30å¤©å†å²æ•°æ®ï¼ˆæ‰€æœ‰è‚¡ç¥¨ï¼‰
python init_historical_data.py --days 30

# ç”Ÿæˆ90å¤©æ•°æ®ï¼ˆå•ä¸ªè‚¡ç¥¨ï¼‰
python init_historical_data.py --days 90 --symbol AAPL

# æ¸…é™¤ç°æœ‰æ•°æ®åé‡æ–°ç”Ÿæˆ
python init_historical_data.py --days 30 --clear

# è¯¦ç»†æ—¥å¿—
python init_historical_data.py --days 30 --verbose
```

**ç”Ÿæˆé€»è¾‘**ï¼š
1. è®¡ç®—äº¤æ˜“æ—¥æ—¶é—´æˆ³ï¼ˆè·³è¿‡å‘¨æœ«ï¼‰
2. ä¸ºæ¯åªè‚¡ç¥¨ç”Ÿæˆå®Œæ•´Kçº¿åºåˆ—
3. æ‰¹é‡æ’å…¥æ•°æ®åº“ï¼ˆæ¯æ‰¹1000æ¡ï¼‰
4. æ›´æ–°è‚¡ç¥¨çŠ¶æ€ä¸ºæœ€æ–°ä»·æ ¼
5. è‡ªåŠ¨èšåˆåˆ°å…¶ä»–å‘¨æœŸ

### 8. é…ç½®æ–‡ä»¶

#### `backend/.env.example`
ç¯å¢ƒå˜é‡é…ç½®æ¨¡æ¿ï¼š

```env
# PostgreSQL é…ç½®ï¼ˆæ¨èï¼‰
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/happystock

# SQLite é…ç½®ï¼ˆä»…å¼€å‘ï¼‰
# DATABASE_URL=sqlite:///happystock.db

# ç»„ä»¶å¼é…ç½®
DB_TYPE=postgresql
DB_HOST=localhost
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=your_password_here
DB_NAME=happystock

# Redis ç¼“å­˜
REDIS_HOST=localhost
REDIS_PORT=6379

# API é…ç½®
API_HOST=0.0.0.0
API_PORT=8000

# CORS
CORS_ORIGINS=http://localhost:3000,http://127.0.0.1:3000

# æ—¥å¿—çº§åˆ«
LOG_LEVEL=INFO
```

#### `backend/Pipfile`
æ›´æ–°çš„Pythonä¾èµ–ï¼š

```toml
[packages]
# ç°æœ‰ä¾èµ–
fastapi = "*"
uvicorn = "*"
psycopg2-binary = "*"
redis = "*"
python-dotenv = "*"

# æ–°å¢ä¾èµ–
numpy = "*"          # æ•°å€¼è®¡ç®—
sqlalchemy = "*"     # ORM
```

### 9. æ–‡æ¡£

#### `backend/DAEMON_README.md`
å®Œæ•´çš„å®ˆæŠ¤è¿›ç¨‹ä½¿ç”¨æ–‡æ¡£ï¼š

- æ¶æ„è¯´æ˜
- å®‰è£…é…ç½®æ­¥éª¤
- è¿è¡Œæ–¹å¼ï¼ˆå¼€å‘/ç”Ÿäº§ï¼‰
- systemdæœåŠ¡é…ç½®ç¤ºä¾‹
- PM2è¿›ç¨‹ç®¡ç†ç¤ºä¾‹
- ç›‘æ§å’Œæ•…éšœæ’æŸ¥
- æ€§èƒ½æŒ‡æ ‡å’Œä¼˜åŒ–å»ºè®®

## ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Market Data System                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Historical   â”‚         â”‚     Market     â”‚         â”‚      Data      â”‚
â”‚  Initializer   â”‚         â”‚   Generator    â”‚         â”‚   Aggregator   â”‚
â”‚                â”‚         â”‚    (Daemon)    â”‚         â”‚    (Daemon)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                          â”‚                          â”‚
        â”‚ Generates                â”‚ Generates                â”‚ Aggregates
        â”‚ historical               â”‚ real-time                â”‚ 1m â†’ 5m,15m...
        â”‚ data                     â”‚ 1m K-lines               â”‚
        â–¼                          â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  PostgreSQL Database                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚market_klinesâ”‚  â”‚ stock_state â”‚  â”‚stock_metadataâ”‚        â”‚
â”‚  â”‚ (Partitioned)â”‚  â”‚             â”‚  â”‚             â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                          â”‚                          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   FastAPI      â”‚
                        â”‚  /api/klines   â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚    Frontend    â”‚
                        â”‚ CandlestickChartâ”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ•°æ®æµ

### åˆå§‹åŒ–æµç¨‹
```
1. è¿è¡Œ init_historical_data.py
2. ç”ŸæˆNå¤©çš„äº¤æ˜“æ—¶é—´æˆ³ï¼ˆè·³è¿‡å‘¨æœ«ï¼‰
3. ä¸ºæ¯åªè‚¡ç¥¨ç”ŸæˆKçº¿åºåˆ—ï¼ˆä½¿ç”¨GBMï¼‰
4. æ‰¹é‡æ’å…¥ market_klines è¡¨
5. æ›´æ–° stock_state è¡¨
6. è‡ªåŠ¨èšåˆåˆ° 5m, 15m, 30m, 60m, 120m
```

### å®æ—¶ç”Ÿæˆæµç¨‹
```
1. MarketDataGenerator æ¯åˆ†é’Ÿæ£€æŸ¥äº¤æ˜“æ—¶æ®µ
2. å¦‚åœ¨äº¤æ˜“æ—¶æ®µï¼š
   a. è¯»å–æ‰€æœ‰è‚¡ç¥¨çš„å½“å‰çŠ¶æ€
   b. ä¸ºæ¯åªè‚¡ç¥¨ç”Ÿæˆä¸‹ä¸€æ ¹Kçº¿
   c. æ£€æŸ¥å¸‚åœºçŠ¶æ€è½¬æ¢ï¼ˆé©¬å°”å¯å¤«é“¾ï¼‰
   d. æ‰¹é‡æ’å…¥ market_klines
   e. æ›´æ–° stock_state
3. DataAggregator æ¯5åˆ†é’Ÿè¿è¡Œï¼š
   a. è¯»å–æœ€è¿‘24å°æ—¶çš„1mæ•°æ®
   b. èšåˆåˆ°å„ä¸ªå‘¨æœŸ
   c. æ’å…¥èšåˆåçš„æ•°æ®
```

### APIæŸ¥è¯¢æµç¨‹
```
1. Frontend è¯·æ±‚ /api/klines?symbol=AAPL&interval=5m&limit=200
2. Backend æŸ¥è¯¢ market_klines è¡¨
3. ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼ˆsymbol, interval, timeï¼‰å¿«é€ŸæŸ¥è¯¢
4. è¿”å› OHLCV æ•°æ®
5. Frontend æ¸²æŸ“åˆ°å›¾è¡¨
```

## æ€§èƒ½ä¼˜åŒ–

### æ•°æ®åº“ä¼˜åŒ–

1. **è¡¨åˆ†åŒº**
   - æŒ‰æœˆåˆ†åŒºï¼ˆmonthly partitionsï¼‰
   - è‡ªåŠ¨è·¯ç”±åˆ°å¯¹åº”åˆ†åŒº
   - æŸ¥è¯¢æ€§èƒ½æå‡ 5-10å€

2. **è¦†ç›–ç´¢å¼•**
   ```sql
   CREATE INDEX idx_market_klines_symbol_interval_time
   ON market_klines (symbol, interval, time DESC)
   INCLUDE (open, high, low, close, volume);
   ```
   - é¿å…å›è¡¨æŸ¥è¯¢
   - æŸ¥è¯¢ç›´æ¥ä»ç´¢å¼•è¿”å›

3. **è¿æ¥æ± **
   - pool_size = 20
   - max_overflow = 30
   - æœ€å¤šæ”¯æŒ50å¹¶å‘è¿æ¥

4. **æ‰¹é‡æ’å…¥**
   - æ¯æ¬¡æ’å…¥1000æ¡
   - å‡å°‘æ•°æ®åº“å¾€è¿”æ¬¡æ•°

### åº”ç”¨å±‚ä¼˜åŒ–

1. **UNLOGGEDè¡¨**
   - stock_realtime_price ä½¿ç”¨UNLOGGED
   - ä¸å†™WALæ—¥å¿—ï¼Œæ€§èƒ½æå‡2-3å€
   - ä»…ç”¨äºä¸´æ—¶æ•°æ®

2. **å®æ—¶ä»·æ ¼ç¼“å­˜**
   - ç‹¬ç«‹è¡¨å­˜å‚¨æœ€æ–°ä»·æ ¼
   - é¿å…æ‰«æå¤§è¡¨

3. **é¢„è®¡ç®—èšåˆ**
   - å®šæœŸé¢„èšåˆæ•°æ®
   - æŸ¥è¯¢æ—¶ç›´æ¥è¯»å–ï¼Œæ— éœ€å®æ—¶è®¡ç®—

## æ€§èƒ½æŒ‡æ ‡

### é¢„æœŸæ€§èƒ½

**å†™å…¥æ€§èƒ½**ï¼š
- å•è‚¡ç¥¨ï¼š1æ¬¡/åˆ†é’Ÿ = 0.0167 QPS
- 10åªè‚¡ç¥¨ï¼š10æ¬¡/åˆ†é’Ÿ = 0.167 QPS
- å³°å€¼ï¼ˆ100åªè‚¡ç¥¨ï¼‰ï¼š100æ¬¡/åˆ†é’Ÿ = 1.67 QPS

**è¯»å–æ€§èƒ½**ï¼š
- å•ç”¨æˆ·ï¼š1æ¬¡/3ç§’ = 0.33 QPS
- 100å¹¶å‘ç”¨æˆ·ï¼š33 QPS
- ç¼“å­˜å‘½ä¸­åï¼š100+ QPS

**æŸ¥è¯¢å“åº”æ—¶é—´**ï¼š
- P50: < 50ms
- P95: < 100ms
- P99: < 200ms

**æ•°æ®è§„æ¨¡ä¼°ç®—**ï¼š
- å•è‚¡ç¥¨/å¤©ï¼š240æ¡ï¼ˆ1mï¼‰ + 48æ¡ï¼ˆ5mï¼‰ + ... â‰ˆ 300æ¡
- 10è‚¡ç¥¨/30å¤©ï¼š90,000æ¡
- 10è‚¡ç¥¨/1å¹´ï¼š1,095,000æ¡ï¼ˆçº¦100ä¸‡ï¼‰
- 100è‚¡ç¥¨/1å¹´ï¼š10,950,000æ¡ï¼ˆçº¦1000ä¸‡ï¼‰

## ä½¿ç”¨æŒ‡å—

### å¿«é€Ÿå¼€å§‹

```bash
# 1. å®‰è£…ä¾èµ–
cd backend
pipenv install

# 2. é…ç½®æ•°æ®åº“
cp .env.example .env
# ç¼–è¾‘ .envï¼Œé…ç½® DATABASE_URL

# 3. åˆå§‹åŒ–æ•°æ®åº“
psql -U postgres -d happystock -f ../sql_scripts/create_market_data_tables.sql

# 4. ç”Ÿæˆå†å²æ•°æ®
pipenv run python init_historical_data.py --days 30

# 5. å¯åŠ¨å®ˆæŠ¤è¿›ç¨‹ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
# ç»ˆç«¯1ï¼šæ•°æ®ç”Ÿæˆå™¨
pipenv run python start_market_generator.py --test

# ç»ˆç«¯2ï¼šæ•°æ®èšåˆå™¨
pipenv run python start_aggregator.py

# 6. éªŒè¯æ•°æ®
psql -U postgres -d happystock -c "
  SELECT symbol, interval, COUNT(*)
  FROM market_klines
  GROUP BY symbol, interval
  ORDER BY symbol, interval;
"
```

### ç”Ÿäº§éƒ¨ç½²

```bash
# ä½¿ç”¨systemdï¼ˆLinuxï¼‰
sudo cp systemd/market-generator.service /etc/systemd/system/
sudo cp systemd/data-aggregator.service /etc/systemd/system/
sudo systemctl enable market-generator data-aggregator
sudo systemctl start market-generator data-aggregator

# æˆ–ä½¿ç”¨PM2ï¼ˆè·¨å¹³å°ï¼‰
pm2 start start_market_generator.py --name market-gen --interpreter python3
pm2 start start_aggregator.py --name data-agg --interpreter python3
pm2 save
pm2 startup
```

## åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰

1. **APIç«¯ç‚¹å¢å¼º**
   - æ·»åŠ æ—¶é—´èŒƒå›´å‚æ•°æ”¯æŒ
   - å®ç°Redisç¼“å­˜å±‚
   - æ·»åŠ æ•°æ®å‹ç¼©

2. **ç›‘æ§å‘Šè­¦**
   - Prometheus metrics
   - å®ˆæŠ¤è¿›ç¨‹å¥åº·æ£€æŸ¥
   - æ•°æ®è´¨é‡ç›‘æ§

3. **æˆäº¤é‡ä¼˜åŒ–**
   - æ›´æ™ºèƒ½çš„æˆäº¤é‡ç®—æ³•
   - è€ƒè™‘æ—¶æ®µå› ç´ ï¼ˆå¼€ç›˜/æ”¶ç›˜æˆäº¤é‡æ›´å¤§ï¼‰
   - è€ƒè™‘å¸‚åœºçŠ¶æ€ï¼ˆç†Šå¸‚æˆäº¤é‡æ›´å¤§ï¼‰

### ä¸­æœŸï¼ˆ1-2æœˆï¼‰

1. **æ›´å¤šè‚¡ç¥¨**
   - æ‰©å±•åˆ°50-100åªè‚¡ç¥¨
   - ä¸åŒè¡Œä¸šæ¿å—
   - ä¸åŒæ³¢åŠ¨ç‡ç‰¹å¾

2. **å¸‚åœºå…³è”æ€§**
   - è‚¡ç¥¨é—´ç›¸å…³æ€§
   - æ¿å—è”åŠ¨
   - å¤§ç›˜æŒ‡æ•°

3. **äº‹ä»¶æ¨¡æ‹Ÿ**
   - éšæœºçªå‘äº‹ä»¶ï¼ˆè·³ç©ºã€æ€¥è·Œï¼‰
   - è´¢æŠ¥å‘å¸ƒå½±å“
   - é‡å¤§æ–°é—»äº‹ä»¶

### é•¿æœŸï¼ˆ3-6æœˆï¼‰

1. **æœºå™¨å­¦ä¹ å¢å¼º**
   - åŸºäºçœŸå®æ•°æ®è®­ç»ƒç”Ÿæˆæ¨¡å‹
   - GANç”Ÿæˆæ›´çœŸå®çš„ä»·æ ¼åºåˆ—
   - å­¦ä¹ çœŸå®å¸‚åœºçš„ç»Ÿè®¡ç‰¹å¾

2. **å¤šå¸‚åœºæ”¯æŒ**
   - Aè‚¡å¸‚åœºç‰¹å¾
   - ç¾è‚¡å¸‚åœºç‰¹å¾
   - åŠ å¯†è´§å¸ç‰¹å¾

3. **è®¢å•ç°¿æ¨¡æ‹Ÿ**
   - å®Œæ•´çš„ä¹°å–ç›˜
   - æ·±åº¦æ•°æ®
   - æ’®åˆå¼•æ“

## æ€»ç»“

âœ… **å·²å®Œæˆ**ï¼š
- âœ… æ•°æ®åº“è¡¨è®¾è®¡ï¼ˆåˆ†åŒºè¡¨ + ç´¢å¼•ä¼˜åŒ–ï¼‰
- âœ… ä»·æ ¼ç”Ÿæˆç®—æ³•ï¼ˆGBM + é©¬å°”å¯å¤«çŠ¶æ€æœºï¼‰
- âœ… æ•°æ®åº“ORMæ¨¡å‹ï¼ˆSQLAlchemyï¼‰
- âœ… å¸‚åœºæ•°æ®ç”Ÿæˆå®ˆæŠ¤è¿›ç¨‹ï¼ˆäº¤æ˜“æ—¶æ®µæ§åˆ¶ï¼‰
- âœ… æ•°æ®èšåˆæ¨¡å—ï¼ˆ1m â†’ å¤šå‘¨æœŸï¼‰
- âœ… å†å²æ•°æ®åˆå§‹åŒ–è„šæœ¬
- âœ… å¯åŠ¨è„šæœ¬å’Œé…ç½®æ–‡ä»¶
- âœ… å®Œæ•´æ–‡æ¡£

ğŸ“Š **æ€§èƒ½ç›®æ ‡**ï¼š
- âœ… æ”¯æŒ100å¹¶å‘ç”¨æˆ·
- âœ… æŸ¥è¯¢å“åº” < 100ms (P95)
- âœ… æ•°æ®åº“ä¼˜åŒ–ï¼ˆåˆ†åŒº + è¦†ç›–ç´¢å¼•ï¼‰
- âœ… è¿æ¥æ± é…ç½®ï¼ˆpool_size=20ï¼‰

ğŸš€ **ä¸‹ä¸€æ­¥**ï¼š
1. å®ç°APIç«¯ç‚¹ï¼ˆæ”¯æŒæ—¶é—´èŒƒå›´æŸ¥è¯¢ï¼‰
2. æ·»åŠ Redisç¼“å­˜å±‚
3. å®æ–½ç›‘æ§å’Œå‘Šè­¦
4. æµ‹è¯•å®ˆæŠ¤è¿›ç¨‹ç¨³å®šæ€§
5. ä¼˜åŒ–æˆäº¤é‡ç”Ÿæˆç®—æ³•

ç³»ç»Ÿå·²å…·å¤‡ç”Ÿäº§ç¯å¢ƒè¿è¡Œçš„åŸºç¡€èƒ½åŠ›ï¼Œå¯ä»¥å¼€å§‹é›†æˆåˆ°ä¸»åº”ç”¨ä¸­å¹¶è¿›è¡Œæµ‹è¯•ã€‚
