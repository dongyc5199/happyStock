-- ============================================================
-- A股虚拟市场完整数据库初始化脚本
-- ============================================================
-- 执行顺序：
--   1. 基础K线数据表（分区表）
--   2. 股票元数据表
--   3. 106只虚拟股票数据
--   4. 指数体系表结构
--   5. 指数成分股初始化
-- ============================================================

\echo '============================================================'
\echo '开始初始化A股虚拟市场数据库...'
\echo '============================================================'

-- ============================================================
-- 第1步：创建市场数据表（K线、股票状态等）
-- ============================================================

\echo '>>> 第1步：创建市场数据表结构...'

\i create_market_data_tables.sql

\echo '✓ 市场数据表创建完成'

-- ============================================================
-- 第2步：初始化106只虚拟股票
-- ============================================================

\echo '>>> 第2步：初始化106只虚拟股票...'

\i init_a_stock_market.sql

\echo '✓ 股票数据初始化完成'

-- ============================================================
-- 第3步：创建指数体系表结构
-- ============================================================

\echo '>>> 第3步：创建指数体系表结构...'

\i create_index_tables.sql

\echo '✓ 指数体系创建完成'

-- ============================================================
-- 完成总结
-- ============================================================

\echo ''
\echo '============================================================'
\echo '✓ 数据库初始化全部完成！'
\echo '============================================================'

-- 显示统计信息
\echo ''
\echo '数据库统计信息：'
\echo '----------------------------------------'

SELECT '股票总数' AS "项目", COUNT(*)::TEXT AS "数值"
FROM stock_metadata WHERE is_active = TRUE
UNION ALL
SELECT '总市值(亿元)', ROUND(SUM(market_cap))::TEXT
FROM stock_metadata WHERE is_active = TRUE
UNION ALL
SELECT '板块数量', COUNT(DISTINCT sector)::TEXT
FROM stock_metadata WHERE is_active = TRUE
UNION ALL
SELECT '核心指数数量', COUNT(*)::TEXT
FROM index_metadata WHERE index_type = 'market'
UNION ALL
SELECT '板块指数数量', COUNT(*)::TEXT
FROM index_metadata WHERE index_type = 'sector'
UNION ALL
SELECT 'HAPPY300成分股', COUNT(*)::TEXT
FROM index_constituents WHERE index_code = 'HAPPY300' AND is_active = TRUE;

\echo ''
\echo '============================================================'
\echo '下一步操作：'
\echo '1. 生成历史数据：python backend/init_historical_data.py --days 90'
\echo '2. 启动数据生成器：python backend/start_market_generator.py --test'
\echo '3. 启动数据聚合器：python backend/start_aggregator.py'
\echo '============================================================'
